(function($){$(document).ready(function(){$("#js-ajaxp-popup").ajaxp2();var modal=$("#js-ajaxp-popup");$("*[data-ajaxp-url]").each(function(){$(this).live("click",function(){$.ajaxp2OpenPopup($(this).data().ajaxpUrl)})})});$.fn.ajaxp2=function(options){var defaults={animation:"fadeAndPop",animationspeed:400,debug:false,defaultClass:"",openAfterContentLoaded:false,};var options=$.extend({},defaults,options);logMessage("Ajaxp2 initialized!");var modal=$(this),topMeasure=parseInt(modal.css("top")),topOffset=modal.height()+topMeasure,locked=false,modalBG=$(".ajaxp-modal-bg");if(modalBG.length==0){modalBG=$('<div class="ajaxp-modal-bg" />').insertAfter(modal)}options.defaultClass=modal.attr("class");modal.unbind("ajaxp:set-options").bind("ajaxp:set-options",function($event,$options){logMessage("ajaxp:set-options");options=$.extend({},options,$options)});modal.unbind("ajaxp:show-preloader").bind("ajaxp:show-preloader",function(){logMessage("ajaxp:show-preloader");$(modal).find(".js-ajaxp-preloader").show()});modal.unbind("ajaxp:hide-preloader").bind("ajaxp:hide-preloader",function(){logMessage("ajaxp:hide-preloader");$(modal).find(".js-ajaxp-preloader").hide()});modal.unbind("ajaxp:clear-contents").bind("ajaxp:clear-contents",function(){logMessage("ajaxp:clear-contents");$(modal).find(".ajax-content").html("")});modal.unbind("ajaxp:set-contents").bind("ajaxp:set-contents",function($event,$html){logMessage("ajaxp:set-contents "+$html.length);$(modal).find(".ajax-content")[0].innerHTML=$html});modal.unbind("ajaxp:ajax-contents-load").bind("ajaxp:ajax-contents-load",function($event,$url,$type,$data){logMessage("ajaxp:ajax-contents-load "+$url+" "+$type+" "+$data);if(typeof $type=="undefined"||$type=="get"){options.currentUrl=$url;$.ajax({url:$url,type:"GET",xhrFields:{withCredentials:true,},crossDomain:false}).done(function($serverResponce){modal.trigger("ajaxp:ajax-contents-loaded",[$serverResponce])})}if($type=="post"){$.ajax({url:$url,type:"POST",xhrFields:{withCredentials:true},data:$data,crossDomain:false}).done(function($serverResponce){modal.trigger("ajaxp:ajax-contents-loaded",[$serverResponce])})}});modal.unbind("ajaxp:ajax-contents-loaded").bind("ajaxp:ajax-contents-loaded",function($event,$serverResponce){logMessage("ajaxp:ajax-contents-loaded "+$serverResponce.length);$serverResponce=$.trim($serverResponce);if($serverResponce.charAt(0)=="{"&&$serverResponce.charAt($serverResponce.length-1)=="}"){var responseJson=jQuery.parseJSON($serverResponce);if(responseJson.redirect){if(responseJson.top){if(responseJson.redirect=="window.location.href"){window.location.href=window.location.href}else{window.location.href=responseJson.redirect}}else{modal.trigger("ajaxp:ajax-contents-load",[responseJson.redirect])}}}else{modal.trigger("ajaxp:hide-preloader");modal.trigger("ajaxp:set-contents",$serverResponce);modal.trigger("ajaxp:ajax-contents-process")}});modal.unbind("ajaxp:ajax-contents-process").bind("ajaxp:ajax-contents-process",function(){logMessage("ajaxp:ajax-contents-process");$(".ajax-content").find("script").each(function(){eval($(this).html())});$(".ajax-content").find("form").each(function(){$(this).submit(function(){if($(this).valid()===false){return false}logMessage("ajaxp:.ajax-content form submit");var url=$(this).attr("action");var data=$(this).serialize();modal.trigger("ajaxp:clear-contents");modal.trigger("ajaxp:show-preloader");options.openAfterContentLoaded=true;modal.trigger("ajaxp:close");modal.trigger("ajaxp:ajax-contents-load",[url,"post",data]);return false})});$(modal).find(".ajax-content").find("a").not(".ajaxp-exclude").each(function(){if(typeof $(this).attr("href")!=="undefined"){$(this).click(function(){logMessage("ajaxp:.ajax-content a click");modal.trigger("ajaxp:clear-contents");modal.trigger("ajaxp:show-preloader");options.openAfterContentLoaded=true;modal.trigger("ajaxp:close");modal.trigger("ajaxp:ajax-contents-load",[$(this).attr("href")]);return false})}})});modal.unbind("ajaxp:open").bind("ajaxp:open",function(){logMessage("ajaxp:open");if(!locked){lockModal();if(options.animation=="fadeAndPop"){modal.css({top:$(document).scrollTop()-topOffset,opacity:0,display:"block",visibility:"visible"});if(modalBG.is(":hidden")){modalBG.fadeIn(options.animationspeed/2)}modal.delay(options.animationspeed/2).animate({top:$(document).scrollTop()+topMeasure+"px",opacity:1},options.animationspeed,unlockModal())}if(options.animation=="fade"){modal.css({opacity:0,display:"block",visibility:"visible",top:$(document).scrollTop()+topMeasure});if(modalBG.is(":hidden")){modalBG.fadeIn(options.animationspeed/2)}modal.delay(options.animationspeed/2).animate({opacity:1},options.animationspeed,unlockModal())}if(options.animation=="none"){modal.css({display:"block",visibility:"visible",top:$(document).scrollTop()+topMeasure});if(modalBG.is(":hidden")){modalBG.css({display:"block"})}unlockModal()}}});modal.unbind("ajaxp:close").bind("ajaxp:close",function(){logMessage("ajaxp:close");if(!locked){lockModal();if(options.animation=="fadeAndPop"){if(!options.openAfterContentLoaded){modalBG.delay(options.animationspeed).fadeOut(options.animationspeed)}modal.animate({top:$(document).scrollTop()-topOffset+"px",opacity:0},options.animationspeed/2,function(){modal.css({top:topMeasure,opacity:1,display:"none",visibility:"hidden"});unlockModal();modal.attr("class",options.defaultClass);if(options.openAfterContentLoaded){var classToSet=options.currentUrl.replace(base_url,"").replace("/","_");modal.addClass(classToSet);modal.trigger("ajaxp:open");options.openAfterContentLoaded=false}})}if(options.animation=="fade"){if(!options.openAfterContentLoaded){modalBG.delay(options.animationspeed).fadeOut(options.animationspeed)}modal.animate({opacity:0},options.animationspeed,function(){modal.css({opacity:1,display:"none",visibility:"hidden",top:topMeasure});unlockModal();modal.attr("class",options.defaultClass);if(options.openAfterContentLoaded){modal.trigger("ajaxp:open");options.openAfterContentLoaded=false}})}if(options.animation=="none"){modal.css({display:"none",visibility:"hidden",top:topMeasure});if(!options.openAfterContentLoaded){modalBG.css({display:"none"})}modal.attr("class",options.defaultClass);if(options.openAfterContentLoaded){modal.trigger("ajaxp:open");options.openAfterContentLoaded=false}}}});var closeButton=$(".close-ajaxp-modal").unbind("click.modalEvent").bind("click.modalEvent",function(){logMessage("ajaxp:closeButton click");modal.trigger("ajaxp:close")});modalBG.unbind("click.modalEvent").bind("click.modalEvent",function(){logMessage("ajaxp:Background click");modal.trigger("ajaxp:close")});$("body").unbind("keyup.modalEvent").bind("keyup.modalEvent",function(e){if(e.which===27){logMessage("ajaxp:Escape click");modal.trigger("ajaxp:close")}});function unlockModal(){locked=false}function lockModal(){locked=true}function logMessage($message){if(options.debug){console.log($message)}}};$.fn.ajaxp2FormSubmit=function(){$(this).submit(function(){if($(this).valid()===false){return false}var modal=$("#js-ajaxp-popup");var url=$(this).attr("action");var data=$(this).serialize();modal.trigger("ajaxp:clear-contents");modal.trigger("ajaxp:show-preloader");modal.trigger("ajaxp:open");modal.trigger("ajaxp:ajax-contents-load",[url,"post",data]);return false})};$.ajaxp2OpenPopup=function($url){var modal=$("#js-ajaxp-popup");var classToSet=$url.replace(base_url,"").replace("/","_");modal.addClass(classToSet);modal.trigger("ajaxp:clear-contents");modal.trigger("ajaxp:show-preloader");modal.trigger("ajaxp:ajax-contents-load",$url);modal.trigger("ajaxp:open")}})(jQuery);