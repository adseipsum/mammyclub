tinymce.PluginManager.add("media",function(k,w){function j(a){return -1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function b(c){var a=k.settings.media_scripts;if(a){for(var d=0;d<a.length;d++){if(-1!==c.indexOf(a[d].filter)){return a[d]}}}}function f(){function n(u){var r,o,m,A;r=y.find("#width")[0],o=y.find("#height")[0],m=r.value(),A=o.value(),y.find("#constrain")[0].checked()&&z&&a&&m&&A&&(u.control==r?(A=Math.round(m/z*A),o.value(A)):(m=Math.round(A/a*m),r.value(m))),z=m,a=A}function e(){d=g(this.value()),this.parent().parent().fromJSON(d)}var y,z,a,d,c=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(i){tinymce.each(i.meta,function(o,m){y.find("#"+m).value(o)})}}];k.settings.media_alt_source!==!1&&c.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),k.settings.media_poster!==!1&&c.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),k.settings.media_dimensions!==!1&&c.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:n},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:n},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),d=x(k.selection.getNode()),z=d.width,a=d.height;var s={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:q(),multiline:!0,label:"Source"};s[l]=e,y=k.windowManager.open({title:"Insert/edit video",data:d,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){d=g(this.next().find("#embed").value()),this.fromJSON(d)},items:c},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(p(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},s]}],onSubmit:function(){var u,m,A,B;for(u=k.dom.select("img[data-mce-object]"),k.insertContent(p(this.toJSON())),m=k.dom.select("img[data-mce-object]"),A=0;A<u.length;A++){for(B=m.length-1;B>=0;B--){u[A]==m[B]&&m.splice(B,1)}}k.selection.select(m[0]),k.nodeChanged()}})}function q(){var a=k.selection.getNode();return a.getAttribute("data-mce-object")?k.selection.getContent():void 0}function p(e){var d="";if(!e.source1&&(tinymce.extend(e,g(e.embed)),!e.source1)){return""}if(e.source2||(e.source2=""),e.poster||(e.poster=""),e.source1=k.convertURL(e.source1,"source"),e.source2=k.convertURL(e.source2,"source"),e.source1mime=j(e.source1),e.source2mime=j(e.source2),e.poster=k.convertURL(e.poster,"poster"),e.flashPlayerUrl=k.convertURL(w+"/moxieplayer.swf","movie"),tinymce.each(v,function(n){var c,a,m;if(c=n.regex.exec(e.source1)){for(m=n.url,a=0;c[a];a++){m=m.replace("$"+a,function(){return c[a]})}e.source1=m,e.type=n.type,e.width=e.width||n.w,e.height=e.height||n.h}}),e.embed){d=h(e.embed,e,!0)}else{var i=b(e.source1);i&&(e.type="script",e.width=i.width,e.height=i.height),e.width=e.width||300,e.height=e.height||150,tinymce.each(e,function(c,a){e[a]=k.dom.encode(c)}),"iframe"==e.type?d+='<iframe src="'+e.source1+'" width="'+e.width+'" height="'+e.height+'"></iframe>':"application/x-shockwave-flash"==e.source1mime?(d+='<object data="'+e.source1+'" width="'+e.width+'" height="'+e.height+'" type="application/x-shockwave-flash">',e.poster&&(d+='<img src="'+e.poster+'" width="'+e.width+'" height="'+e.height+'" />'),d+="</object>"):-1!=e.source1mime.indexOf("audio")?k.settings.audio_template_callback?d=k.settings.audio_template_callback(e):d+='<audio controls="controls" src="'+e.source1+'">'+(e.source2?'\n<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==e.type?d+='<script src="'+e.source1+'"><\/script>':d=k.settings.video_template_callback?k.settings.video_template_callback(e):'<video width="'+e.width+'" height="'+e.height+'"'+(e.poster?' poster="'+e.poster+'"':"")+' controls="controls">\n<source src="'+e.source1+'"'+(e.source1mime?' type="'+e.source1mime+'"':"")+" />\n"+(e.source2?'<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</video>"}return d}function g(c){var a={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(m,d){if(a.source1||"param"!=m||(a.source1=d.map.movie),("iframe"==m||"object"==m||"embed"==m||"video"==m||"audio"==m)&&(a.type||(a.type=m),a=tinymce.extend(d.map,a)),"script"==m){var n=b(d.map.src);if(!n){return}a={type:"script",source1:d.map.src,width:n.width,height:n.height}}"source"==m&&(a.source1?a.source2||(a.source2=d.map.src):a.source1=d.map.src),"img"!=m||a.poster||(a.poster=d.map.src)}}).parse(c),a.source1=a.source1||a.src||a.data,a.source2=a.source2||"",a.poster=a.poster||"",a}function x(a){return a.getAttribute("data-mce-object")?g(k.serializer.serialize(a,{selection:!0})):{}}function h(u,n,m){function s(D,B){var A,C,E,c;for(A in B){if(E=""+B[A],D.map[A]){for(C=D.length;C--;){c=D[C],c.name==A&&(E?(D.map[A]=E,c.value=E):(delete D.map[A],D.splice(C,1)))}}else{E&&(D.push({name:A,value:E}),D.map[A]=E)}}}var y,d=new tinymce.html.Writer,z=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){d.comment(a)},cdata:function(a){d.cdata(a)},text:function(c,a){d.text(c,a)},start:function(c,i,a){switch(c){case"video":case"object":case"embed":case"img":case"iframe":s(i,{width:n.width,height:n.height})}if(m){switch(c){case"video":s(i,{poster:n.poster,src:""}),n.source2&&s(i,{src:""});break;case"iframe":s(i,{src:n.source1});break;case"source":if(z++,2>=z&&(s(i,{src:n["source"+z],type:n["source"+z+"mime"]}),!n["source"+z])){return}break;case"img":if(!n.poster){return}y=!0}}d.start(c,i,a)},end:function(i){if("video"==i&&m){for(var o=1;2>=o;o++){if(n["source"+o]){var c=[];c.map={},o>z&&(s(c,{src:n["source"+o],type:n["source"+o+"mime"]}),d.start("source",c,!0))}}}if(n.poster&&"object"==i&&m&&!y){var a=[];a.map={},s(a,{src:n.poster,width:n.width,height:n.height}),d.start("img",a,!0)}d.end(i)}},new tinymce.html.Schema({})).parse(u),d.getContent()}var v=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}],l=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";k.on("ResolveName",function(c){var a;1==c.target.nodeType&&(a=c.target.getAttribute("data-mce-object"))&&(c.name=a)}),k.on("preInit",function(){var c=k.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(d){c[d]=new RegExp("</"+d+"[^>]*>","gi")});var a=k.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(d){a[d]={}}),k.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(F,A){for(var e,D,C,r,G,y,E,B,z=F.length;z--;){if(D=F[z],D.parent&&("script"!=D.name||(B=b(D.attr("src"))))){for(C=new tinymce.html.Node("img",1),C.shortEnded=!0,B&&(B.width&&D.attr("width",B.width.toString()),B.height&&D.attr("height",B.height.toString())),y=D.attributes,e=y.length;e--;){r=y[e].name,G=y[e].value,"width"!==r&&"height"!==r&&"style"!==r&&(("data"==r||"src"==r)&&(G=k.convertURL(G,r)),C.attr("data-mce-p-"+r,G))}E=D.firstChild&&D.firstChild.value,E&&(C.attr("data-mce-html",escape(E)),C.firstChild=null),C.attr({width:D.attr("width")||"300",height:D.attr("height")||("audio"==A?"30":"150"),style:D.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":A,"class":"mce-object mce-object-"+A}),D.replace(C)}}}),k.serializer.addAttributeFilter("data-mce-object",function(C,G){for(var B,d,y,E,D,z,H,A=C.length;A--;){if(B=C[A],B.parent){for(H=B.attr(G),d=new tinymce.html.Node(H,1),"audio"!=H&&"script"!=H&&d.attr({width:B.attr("width"),height:B.attr("height")}),d.attr({style:B.attr("style")}),E=B.attributes,y=E.length;y--;){var F=E[y].name;0===F.indexOf("data-mce-p-")&&d.attr(F.substr(11),E[y].value)}"script"==H&&d.attr("type","text/javascript"),D=B.attr("data-mce-html"),D&&(z=new tinymce.html.Node("#text",3),z.raw=!0,z.value=unescape(D),d.append(z)),B.replace(d)}}})}),k.on("ObjectSelected",function(c){var a=c.target.getAttribute("data-mce-object");("audio"==a||"script"==a)&&c.preventDefault()}),k.on("objectResized",function(d){var c,a=d.target;a.getAttribute("data-mce-object")&&(c=a.getAttribute("data-mce-html"),c&&(c=unescape(c),a.setAttribute("data-mce-html",escape(h(c,{width:d.width,height:d.height})))))}),k.addButton("media",{tooltip:"Insert/edit video",onclick:f,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]}),k.addMenuItem("media",{icon:"media",text:"Insert video",onclick:f,context:"insert",prependToContext:!0})});