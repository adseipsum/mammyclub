tinymce.PluginManager.add("image",function(f){function d(l,k){function j(n,a){m.parentNode&&m.parentNode.removeChild(m),k({width:n,height:a})}var m=document.createElement("img");m.onload=function(){j(m.clientWidth,m.clientHeight)},m.onerror=function(){j()};var h=m.style;h.visibility="hidden",h.position="fixed",h.bottom=h.left=0,h.width=h.height="auto",document.body.appendChild(m),m.src=l}function c(j,h,a){function k(m,l){return l=l||[],tinymce.each(m,function(n){var i={text:n.text||n.title};n.menu?i.menu=k(n.menu):(i.value=n.value,h(i)),l.push(i)}),l}return k(j,a||[])}function g(a){return function(){var e=f.settings.image_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(h){a(tinymce.util.JSON.parse(h))}}):"function"==typeof e?e(a):a(e)}}function b(k){function D(){var l,h,a,m;l=A.find("#width")[0],h=A.find("#height")[0],l&&h&&(a=l.value(),m=h.value(),A.find("#constrain")[0].checked()&&z&&E&&a&&m&&(z!=a?(m=Math.round(a/z*m),h.value(m)):(a=Math.round(m/E*a),l.value(a))),z=a,E=m)}function t(){function a(l){function h(){l.onload=l.onerror=null,f.selection&&(f.selection.select(l),f.nodeChanged())}l.onload=function(){q.width||q.height||!C||i.setAttribs(l,{width:l.clientWidth,height:l.clientHeight}),h()},l.onerror=h}F(),D(),q=tinymce.extend(q,A.toJSON()),q.alt||(q.alt=""),""===q.width&&(q.width=null),""===q.height&&(q.height=null),q.style||(q.style=null),q={src:q.src,alt:q.alt,width:q.width,height:q.height,style:q.style,"class":q["class"]},f.undoManager.transact(function(){return q.src?(x?i.setAttribs(x,q):(q.id="__mcenew",f.focus(),f.selection.setContent(i.createHTML("img",q)),x=i.get("__mcenew"),i.setAttrib(x,"id",null)),void a(x)):void (x&&(i.remove(x),f.focus(),f.nodeChanged()))})}function j(a){return a&&(a=a.replace(/px$/,"")),a}function e(a){var h=a.meta||{};w&&w.value(f.convertURL(this.value(),"src")),tinymce.each(h,function(m,l){A.find("#"+l).value(m)}),h.width||h.height||d(this.value(),function(l){l.width&&l.height&&C&&(z=l.width,E=l.height,A.find("#width").value(z),A.find("#height").value(E))})}function F(){function h(m){return m.length>0&&/^[0-9]+$/.test(m)&&(m+="px"),m}if(f.settings.image_advtab){var a=A.toJSON(),l=i.parseStyle(a.style);delete l.margin,l["margin-top"]=l["margin-bottom"]=h(a.vspace),l["margin-left"]=l["margin-right"]=h(a.hspace),l["border-width"]=h(a.border),A.find("#style").value(i.serializeStyle(i.parseStyle(i.serializeStyle(l))))}}var A,z,E,w,v,q={},i=f.dom,x=f.selection.getNode(),C=f.settings.image_dimensions!==!1;z=i.getAttrib(x,"width"),E=i.getAttrib(x,"height"),"IMG"!=x.nodeName||x.getAttribute("data-mce-object")||x.getAttribute("data-mce-placeholder")?x=null:q={src:i.getAttrib(x,"src"),alt:i.getAttrib(x,"alt"),"class":i.getAttrib(x,"class"),width:z,height:E},k&&(w={type:"listbox",label:"Image list",values:c(k,function(a){a.value=f.convertURL(a.value||a.url,"src")},[{text:"None",value:""}]),value:q.src&&f.convertURL(q.src,"src"),onselect:function(h){var a=A.find("#alt");(!a.value()||h.lastControl&&a.value()==h.lastControl.text())&&a.value(h.control.text()),A.find("#src").value(h.control.value()).fire("change")},onPostRender:function(){w=this}}),f.settings.image_class_list&&(v={name:"class",type:"listbox",label:"Class",values:c(f.settings.image_class_list,function(a){a.value&&(a.textStyle=function(){return f.formatter.getCssText({inline:"img",classes:[a.value]})})})});var B=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:e},w];f.settings.image_description!==!1&&B.push({name:"alt",type:"textbox",label:"Image description"}),C&&B.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:D,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:D,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),B.push(v),f.settings.image_advtab?(x&&(q.hspace=j(x.style.marginLeft||x.style.marginRight),q.vspace=j(x.style.marginTop||x.style.marginBottom),q.border=j(x.style.borderWidth),q.style=f.dom.serializeStyle(f.dom.parseStyle(f.dom.getAttrib(x,"style")))),A=f.windowManager.open({title:"Insert/edit image",data:q,bodyType:"tabpanel",body:[{title:"General",type:"form",items:B},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:F},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:t})):A=f.windowManager.open({title:"Insert/edit image",data:q,body:B,onSubmit:t})}f.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:g(b),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"}),f.addMenuItem("image",{icon:"image",text:"Insert image",onclick:g(b),context:"insert",prependToContext:!0}),f.addCommand("mceImage",g(b))});