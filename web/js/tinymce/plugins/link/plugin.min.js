tinymce.PluginManager.add("link",function(b){function c(f){return function(){var e=b.settings.link_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(g){f(tinymce.util.JSON.parse(g))}}):"function"==typeof e?e(f):f(e)}}function d(g,h,j){function f(e,i){return i=i||[],tinymce.each(e,function(m){var k={text:m.text||m.title};m.menu?k.menu=f(m.menu):(k.value=m.value,h&&h(k)),i.push(k)}),i}return f(g,j||[])}function a(J){function F(f){var g=I.find("#text");(!g.value()||f.lastControl&&g.value()==f.lastControl.text())&&g.value(f.control.text()),I.find("#href").value(f.control.value())}function D(f){var g=[];return tinymce.each(b.dom.select("a:not([href])"),function(h){var e=h.name||h.id;e&&g.push({text:e,value:"#"+e,selected:-1!=f.indexOf("#"+e)})}),g.length?(g.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:g,onselect:F}):void 0}function N(){!L&&0===j.text.length&&K&&this.parent().parent().find("#text")[0].value(this.value())}function B(f){var g=f.meta||{};n&&n.value(b.convertURL(this.value(),"href")),tinymce.each(f.meta,function(h,i){I.find("#"+i).value(h)}),g.text||N.call(this)}function z(g){var h=M.getContent();if(/</.test(h)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(h)||-1==h.indexOf("href="))){return !1}if(g){var k,f=g.childNodes;if(0===f.length){return !1}for(k=f.length-1;k>=0;k--){if(3!=f[k].nodeType){return !1}}}return !0}var w,t,L,I,K,H,n,q,G,C,A,E,j={},M=b.selection,O=b.dom;w=M.getNode(),t=O.getParent(w,"a[href]"),K=z(),j.text=L=t?t.innerText||t.textContent:M.getContent({format:"text"}),j.href=t?O.getAttrib(t,"href"):"",(E=O.getAttrib(t,"target"))?j.target=E:b.settings.default_link_target&&(j.target=b.settings.default_link_target),(E=O.getAttrib(t,"rel"))&&(j.rel=E),(E=O.getAttrib(t,"class"))&&(j["class"]=E),(E=O.getAttrib(t,"title"))&&(j.title=E),K&&(H={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){j.text=this.value()}}),J&&(n={type:"listbox",label:"Link list",values:d(J,function(f){f.value=b.convertURL(f.value||f.url,"href")},[{text:"None",value:""}]),onselect:F,value:b.convertURL(j.href,"href"),onPostRender:function(){n=this}}),b.settings.target_list!==!1&&(b.settings.target_list||(b.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),G={name:"target",type:"listbox",label:"Target",values:d(b.settings.target_list)}),b.settings.rel_list&&(q={name:"rel",type:"listbox",label:"Rel",values:d(b.settings.rel_list)}),b.settings.link_class_list&&(C={name:"class",type:"listbox",label:"Class",values:d(b.settings.link_class_list,function(f){f.value&&(f.textStyle=function(){return b.formatter.getCssText({inline:"a",classes:[f.value]})})})}),b.settings.link_title!==!1&&(A={name:"title",type:"textbox",label:"Title",value:j.title}),I=b.windowManager.open({title:"Insert link",data:j,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:B,onkeyup:N},H,A,D(j.href),n,q,G,C],onSubmit:function(h){function k(m,o){var l=b.selection.getRng();window.setTimeout(function(){b.windowManager.confirm(m,function(i){b.selection.setRng(l),o(i)})},0)}function g(){var i={href:f,target:j.target?j.target:null,rel:j.rel?j.rel:null,"class":j["class"]?j["class"]:null,title:j.title?j.title:null};t?(b.focus(),K&&j.text!=L&&("innerText" in t?t.innerText=j.text:t.textContent=j.text),O.setAttribs(t,i),M.select(t),b.undoManager.add()):K?b.insertContent(O.createHTML("a",i,O.encode(j.text))):b.execCommand("mceInsertLink",!1,i)}var f;return j=tinymce.extend(j,h.data),(f=j.href)?f.indexOf("@")>0&&-1==f.indexOf("//")&&-1==f.indexOf("mailto:")?void k("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(e){e&&(f="mailto:"+f),g()}):/^\s*www\./i.test(f)?void k("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(e){e&&(f="http://"+f),g()}):void g():void b.execCommand("unlink")}})}b.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:c(a),stateSelector:"a[href]"}),b.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),b.addShortcut("Ctrl+K","",c(a)),b.addCommand("mceLink",c(a)),this.showDialog=a,b.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:c(a),stateSelector:"a[href]",context:"insert",prependToContext:!0})});