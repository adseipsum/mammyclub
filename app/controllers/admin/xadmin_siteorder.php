<?php if (!defined("BASEPATH")) exit("No direct script access allowed");
/**
 * xAdmin_SiteOrder
 * This class has been auto-generated by Itirra
 */
require_once APPPATH . 'controllers/admin/base/base_admin_controller.php';
class xAdmin_SiteOrder extends Base_Admin_Controller {

  /** Export */
  protected $export = TRUE;

  /** Additional Actions. Simple Array. Ex. array('view', 'print')*/
  protected $additionalItemActions = array('preview', 'generate_order_shipmet_doc_on_confirmed_stock', 'generate_order_shipmet_doc', 'create_ttn', 'send_ty_email', 'siteorder_products_reserve');

  /** Additional Actions. */
  protected $additionalActions = array('siteorder_restore_process', 'siteorder_report_process', 'assemble');

  /** Pre update cart items */
  protected $preUpdateCartItems = array();

  /** SearchParams. */
//   protected $searchParams = array("email");

  /** Filters. */
  protected $filters = array("paid" => "",
                             "siteorder_status.id" => "",
                             "manager.id" => "",
                             "shipment_store.id" => "",
                             "np_sender.id" => "",
                             "request_review" => "");

  /** DateFilters. */
  protected $dateFilters = array("created_at", "shipment_date", "paid_date");

  /** SearchParams. */
  protected $searchParams = array("fio", "email", "phone", "involvement_chanel", "code");

  /**
   * initBatchUpdateFields
   */
  protected function initBatchUpdateFields() {
    $this->batchUpdateFields = array("paid" => "", "manager.id" => "");
  }

	/**
	 * @param $id
	 */
	public function ajax_batch_process_popup($siteOrderStatusId) {

		$siteOrderStatus = ManagerHolder::get('SiteOrderStatus')->getById($siteOrderStatusId, 'k');

		$broadcastText = '';

		if ($siteOrderStatus['k'] == SITEORDER_STATUS_WAIT || $siteOrderStatus['k'] == SITEORDER_STATUS_CLIENT_CONFIRMED) {
			$broadcastText = 'подтвержден';
		}

		if ($siteOrderStatus['k'] == SITEORDER_STATUS_SHIPPED) {
			$broadcastText = 'отправлен';
		}

		$this->layout->setLayout('ajax');
		$this->layout->set('broadcastText', $broadcastText);
		$this->layout->view('siteorder/ajax_batch_process_order_confirmed_broadcast_send');
	}


	/**
	 * Bacth process function
	 */
	public function batch_process() {
		simple_validate_post('ids');
		$ids = explode(',', $_POST['ids']);
		$this->load->helper('cookie');

		// UPDATE
		if (isset($_POST['update'])) {

			foreach ($ids as $id) {

				$update = array();

				$result = ManagerHolder::get('SiteOrder')->batchUpdateFromPostData();

				$siteOrder = ManagerHolder::get('SiteOrder')->getById($id, 'e.*');

//				if (empty($result['shipment_store.id']) && empty($siteOrder['shipment_store_id'])) {
//					set_flash_error('Не указан склад отгрузки или дата отгрузки');
//					redirect_to_referral();
//				}

				if (isset($result['paid'])) {
					$update['paid'] = $result['paid'];
          if ($update['paid']) {
            $update['paid_date'] = date(DOCTRINE_DATE_FORMAT);
          }
				}

				if (isset($result['siteorder_status.id'])) {
					$update['siteorder_status_id'] = $result['siteorder_status.id'];
            // To send a letter?
					if (!empty($result['popup_value']) && $result['popup_value'] == 1) {

						if ($result['siteorder_status'] == SITEORDER_STATUS_WAIT || $result['siteorder_status'] == SITEORDER_STATUS_CLIENT_CONFIRMED) {

              if (empty($siteOrder['shipment_store_id']) && empty($result['shipment_store.id']) || empty($siteOrder['shipment_date'])) {
                set_flash_error('Не указан склад отгрузки или дата отгрузки');
                redirect_to_referral();
              } else {
                ManagerHolder::get('OrderConfirmedBroadcast')->sendBySiteOrder($id);
              }

						}
						if ($result['siteorder_status'] == SITEORDER_STATUS_SHIPPED) {

              if (!empty($siteOrder['ttn_code'])) {
                ManagerHolder::get('OrderBroadcast')->sendBySiteOrder($id);
              } else {
                set_flash_error('Не указан номер ТТН');
                redirect_to_referral();
              }

						}
					}

          // Event trigger on changed status
          if ($siteOrder['siteorder_status_id'] != $result['siteorder_status.id']) {
            $fromStatus = ManagerHolder::get('SiteOrderStatus')->getById($siteOrder['id'], 'e.*');
            $toStatus = ManagerHolder::get('SiteOrderStatus')->getById($result['siteorder_status.id'], 'e.*');
            Events::trigger('SiteOrder.changeStatus', array('id' => $siteOrder['id'], 'from' => $fromStatus, 'to' => $toStatus));
          }

				}

				if (isset($result['manager.id'])) {
					$update['manager_id'] = $result['manager.id'];
				}

				if (isset($result['shipment_store.id'])) {
					$update['shipment_store_id'] = $result['shipment_store.id'];
				}

				if (isset($result['request_review'])) {
					$update['request_review'] = $result['request_review'];
				}

				if (!empty($update)) {
					ManagerHolder::get('SiteOrder')->updateAllWhere(array('id' => $id), $update);
				}
			}

		}

		parent::batch_process();





		// Send mass "Thank you" mail from selected siteorders
		if (isset($_POST['send_ty_mail'])) {

			$countStatusDone = 0;
			$countStatusError = 0;

			for ($i = 0; $i < count($ids); ++$i) {
				$result = ManagerHolder::get('TyBroadcast')->sendBySiteOrder($ids[$i]);
				if ($result['status'] == 'error') {
					$countStatusError++;
				} else {
					$countStatusDone++;
				}
			}

			set_flash_notice('Отправлен(о) ' . $countStatusDone . ' email.    ' . $countStatusError . ' email отправлен(ы) ранее');
			redirect_to_referral();

		}

		// Резерв товаров
		if (isset($_POST['products_reserved'])) {

			foreach ($ids as $id) {
				ManagerHolder::get('SiteOrder')->products_reserved($id);
			}

			set_flash_notice('Товары успешно зарезервированы');
			redirect_to_referral();

		}

		// Заявки в архиве
		if (isset($_POST['request_zammler']) || isset($_POST['request_supplier'])) {

			$files = array();
			foreach ($ids as $id) {
				$siteOrder = ManagerHolder::get('SiteOrder')->getById($id, 'e.*, items.*');

				if (!empty($siteOrder['items'])) {

					if (isset($_POST['request_zammler'])) {
						$files[] = ManagerHolder::get('SiteOrder')->genereteOrderShimpentDocOnConfirmedStock($siteOrder['id']);
					} else {
						$files[] = ManagerHolder::get('SiteOrder')->genereteOrderShimpentDoc($siteOrder['id']);
					}
				}
			}

			if (!empty($files)) {
				$this->load->library('Zip');
				$this->zip->makeZipArchive($files);
			}
		}

		// Создать ТТН
		if (isset($_POST['create_ttn'])) {
			$results = array();
			foreach ($ids as $id) {
				$results[] = ManagerHolder::get('SiteOrder')->CreateTtn($id);

			}

			$statusTrue = '';
			$statusFalse = '';
			$statusError = '';

			foreach ($results as $result) {
				if ($result['is_success'] == true) {
					$statusTrue .= $result['siteorder_code'] . ', ';
				} elseif (!empty($result['erorrs'])) {
          $statusError .= $result['siteorder_code'] . '-' . $result['erorrs'] . ', ';
        } elseif ($result['is_success'] == false) {
					$statusFalse .= $result['siteorder_code'] . ', ';
				}
			}
			set_flash_notice(
				(strlen($statusTrue) > 1 ? 'Успешно созданы: ' . $statusTrue : '') .
				(strlen($statusFalse) > 1 ? ' Не указан склад отгрузки: ' . $statusFalse : '') .
				(strlen($statusError) > 1 ? ' Ошибки: ' . $statusError : '')
			);
			redirect_to_referral();
		}

	}


	/**
	 * Reserve products
	 * @param $siteOrderId
	 */
	public function siteorder_products_reserve($siteOrderId) {
	  $siteOrder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'shipment_store_id');
    if (empty($siteOrder['shipment_store_id'])) {
      set_flash_error('Не указан склад отгрузки');
      $this->redirectToReffer();
    }
    if ($siteOrder['shipment_store_id'] != MC_STORE_ID && $siteOrder['shipment_store_id'] != ZAMMLER_STORE_ID) {
      set_flash_error('Не указан подходящий склад отгрузки');
      $this->redirectToReffer();
    }

		$result = ManagerHolder::get('SiteOrder')->siteorderProductsReserve($siteOrderId);

		if ($result) {
			set_flash_notice('Товары успешно зарезервированы');
			$this->redirectToReffer();
		}

  }


	/**
	 * Load ajax popup on siteorder for siteorder_restore_process().
	 */
	public function siteorder_restore() {

		$this->layout->setLayout('ajax');
		$this->layout->view('siteorder/siteorder_restore');
  }


	/**
	 * Restore soft_deleted order by ID.
	 */
	public function siteorder_restore_process() {
		$this->load->helper('common/itirra_ajax');

		$siteOrder = ManagerHolder::get('SiteOrder')->executeNativeSQL("SELECT count(1) as exist 
																																		FROM site_order 
																																		WHERE id = '" . $_POST['siteorder_id']. "' 
																																		AND soft_deleted = 1 
																																		LIMIT 1");
		if ($siteOrder[0]['exist'] == 1) {
			ManagerHolder::get('SiteOrder')->updateById($_POST['siteorder_id'], 'soft_deleted', 0);
			set_flash_message('notice', 'Заказ успешно востановлен');
			uni_redirect(get_referrer(), true);
			} else {
			set_flash_error('Вы пытаетесь восстановить активный или не существующий заказ!');
			uni_redirect(get_referrer(), true);
		}
	}


  /**
   * Delete.
   * @param integer $entityId
   */
  public function delete($entityId) {
    $this->checkPermissions("_delete");
    $entity = ManagerHolder::get($this->managerName)->getById($entityId, 'id');
    if (empty($entity)) {
      show_404();
    }
    ManagerHolder::get($this->managerName)->updateById($entityId, 'soft_deleted', TRUE);
    $this->addAdminLogRecord($entity, 'delete', $this->managerName, 'Soft delete, id=' . $entityId);
    ManagerHolder::get('SiteOrder')->deleteFromRetailCrm($entityId);
    set_flash_notice('admin.messages.' . strtolower($this->entityName) . '.delete');
    $this->redirectToReffer();
  }

  /**
   * DeleteFromDb.
   * Deletes entity from DB and its images.
   * @param integer $entityId
   * @return Object (the deleted entity)
   */
  protected function deleteFromDb($entityId) {
    $entity = ManagerHolder::get($this->managerName)->getById($entityId, 'e.*');

    ManagerHolder::get($this->managerName)->updateById($entityId, 'soft_deleted', TRUE);
    $this->addAdminLogRecord($entity, 'delete', $this->managerName, 'Soft delete, id=' . $entityId);
    return $entity;
  }


  /**
   * generate_order_shipmet_doc
   * @param array $sitorderId
   */
  public function generate_order_shipmet_doc_old($sitorderId) {

    $siteOrder = ManagerHolder::get('SiteOrder')->getById($sitorderId, 'e.*, items.*, delivery_city.*');
    if (empty($siteOrder) || !isset($siteOrder['items']) || empty($siteOrder['items'])) {
      redirect_to_referral();
    }

    require_once('./lib/phpExcel/PHPExcel.php');
    require_once('./lib/phpExcel/PHPExcel/Writer/Excel5.php');

    $borderStyle = array('allborders' => array('style' => PHPExcel_Style_Border::BORDER_MEDIUM,
                                               'color' => array('rgb' => '000000')));

    $fontStyle = array('name' => 'Times New Roman', 'size' => 11);
    $fontBoldStyle = array_merge($fontStyle, array('bold' => true));

    $xls = new PHPExcel();
    $xls->setActiveSheetIndex(0);
    $sheet = $xls->getActiveSheet();
    $sheet->setTitle('Відвантаження');

    $sheet->getColumnDimension("B")->setWidth(20);
    $sheet->getColumnDimension("D")->setWidth(30);
    $sheet->getColumnDimension("E")->setWidth(13);

    $sheet->setCellValue("A1", 'Заказ от MammyClub НА КЛИЕНТА');
    $sheet->getStyle('A1')->getFont()->applyFromArray($fontBoldStyle);
    $sheet->mergeCells('A1:F1');
    $sheet->getStyle('A1')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);

    $sheet->setCellValue("A3", 'Получатель:');
    $sheet->getStyle('A3')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $sheet->getStyle('A3')->getFont()->applyFromArray($fontBoldStyle);
//
//    $sheet->setCellValue("C2", $siteOrder['code']);
//    $sheet->getStyle('C2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
//    $sheet->getStyle('C2')->getFont()->applyFromArray($fontStyle);
//    $sheet->getStyle('C2')->getBorders()->applyFromArray($borderStyle);

//    $sheet->setCellValue("D2", 'Дата заявки:');
//    $sheet->getStyle('D2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
//    $sheet->getStyle('D2')->getFont()->applyFromArray($fontBoldStyle);
//
//    $sheet->setCellValue("E2", date('Y-m-d'));
//    $sheet->getStyle('E2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
//    $sheet->getStyle('E2')->getFont()->applyFromArray($fontStyle);
//    $sheet->getStyle('E2')->getBorders()->applyFromArray($borderStyle);

    // Order table
//    $addressDelivery = $siteOrder['delivery_post'];
    $addressDelivery = 'НЕТ';
    if ($siteOrder['delivery_type'] == 'delivery-to-home') {
      $addressDelivery = $siteOrder['delivery_street'] . ', ' . $siteOrder['delivery_house'] . ', ' . $siteOrder['delivery_flat'];
    }
    $postDelivery = 'НЕТ';
    if ($siteOrder['delivery_type'] == 'delivery-to-post') {
      $postDelivery = $siteOrder['delivery_post'];
    }

    $orderData = array(
                       'ФИО' => $siteOrder['fio'],
                       'Телефон' => $siteOrder['phone'] . ' ',
                       'Город' => $siteOrder['delivery_city']['name'],
                       'Адресная доставка' => $addressDelivery,
                       'Доставка на склад Новой Почты' => $postDelivery,

//                       'Замовник' => 'ФОП Пода (MammyClub.com)',
//                       'Перевізник' => 'Новая Почта',
//                       'Платник доставки' => 'ФОП Пода, ЕДРПО 282845605576',
//                       'Форма розрахунку за доставку' => 'Безготiвкова',
//                       'Сума наложеного платежу' => $siteOrder['total'],
//                       'Платник за наложку' => 'Отримувач',
//                       'Внутрішній № замовлення' => $siteOrder['code'],
//                       'Сума післяплати товар' => $siteOrder['payment_type']=='cash'?$siteOrder['total']:'0',
//                       'Інші додаткові послуги' => 'нет',
//                       'ІПН Відправника' => '2845605576'
    );

    $rowNum = 4;
    foreach ($orderData as $k => $v) {
      $sheet->mergeCellsByColumnAndRow(0, $rowNum, 1, $rowNum);
      $sheet->setCellValueByColumnAndRow(0, $rowNum, $k);
      $sheet->mergeCellsByColumnAndRow(2, $rowNum, 5, $rowNum);
      $sheet->setCellValueByColumnAndRow(2, $rowNum, (string)$v);
      for ($i=2; $i<=5; $i++) {
        $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
      }
      $sheet->getStyleByColumnAndRow(2, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
      $rowNum++;
    }
    $rowNum++;

    $sheet->setCellValueByColumnAndRow(0, $rowNum, 'Оплата доставки:');
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getFont()->applyFromArray($fontBoldStyle);
    $rowNum++;

    $sheet->setCellValueByColumnAndRow(0, $rowNum, 'Оплата доставки ЗА НАШ СЧЕТ');
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $rowNum++;

    $sheet->setCellValueByColumnAndRow(0, $rowNum, 'Просим вас оплатить доставку, мы гарантируем возврат этих денег');
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $rowNum+=2;


    $sheet->setCellValueByColumnAndRow(0, $rowNum, 'Наложенный платеж:');
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getFont()->applyFromArray($fontBoldStyle);
    $rowNum++;

    $total = 'Без наложенного платежа';
    if ($siteOrder['payment_type'] == 'cash') {
      if (!empty($siteOrder['total_with_discount']) && $siteOrder['total_with_discount'] > 0) {
        $total = $siteOrder['total_with_discount'];
      } else {
        $total = $siteOrder['total'];
      }
    }
    $sheet->setCellValueByColumnAndRow(0, $rowNum, $total);
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $rowNum++;

    $payment = '';
    if ($siteOrder['payment_type'] == 'cash') {
      $payment = 'Оплата наложенного платежа за счет получателя';
    }
    $sheet->setCellValueByColumnAndRow(0, $rowNum, $payment);
    $sheet->getStyleByColumnAndRow(0, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
    $rowNum+=2;

    // Product table
    $sheet->getRowDimension($rowNum)->setRowHeight('34,5');

    $productDataFields = array(0 => 'index', 1 => 'bar_code', 2 => 'product_code', 3 => 'name', 5 => 'qty');

    $productData = array();
    foreach ($siteOrder['items'] as $i => $cartItem) {
    	$productName = $cartItem['product']['name'];
    	$productBarCode = !empty($cartItem['product']['bar_code'])?$cartItem['product']['bar_code']:'';
    	$productCode = !empty($cartItem['product']['product_code'])?$cartItem['product']['product_code']:'';
    	if (!empty($cartItem['additional_product_params'])) {
    		$cartItem['additional_product_params'] = ManagerHolder::get('ParameterValue')->getAsViewArray(array(), 'name', null, array('id' => unserialize($cartItem['additional_product_params'])));
    		$productName .= ' [' . implode(', ', $cartItem['additional_product_params']) . ']';
    		// Check for parameter group by parameter values
    		foreach ($cartItem['additional_product_params'] as $paramId => $paramName) {
    			$paramGroup = ManagerHolder::get('ParameterGroup')->getOneWhere(array('product_id' => $cartItem['product_id'], 'main_parameter_value_id' => $paramId), 'e.*');
    			if (!empty($paramGroup)) {
            $productBarCode = !empty($paramGroup['bar_code'])?$paramGroup['bar_code']:'';
            $productCode = !empty($paramGroup['product_code'])?$paramGroup['product_code']:'';
    				break;
    			}
    		}
    	}
    	$productData[] = array('index' => $i+1,
								 	    			 'bar_code'  => $productBarCode . ' ',
                             'product_code' => $productCode,
									    			 'name'  => $productName,
									    			 'qty'   => $cartItem['qty']);
    }
    // Product table header
    $sheet->mergeCellsByColumnAndRow(3, $rowNum, 4, $rowNum);
    for ($i=0; $i<=5; $i++) {
      $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
      $sheet->getStyleByColumnAndRow($i, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER)->setVertical(PHPExcel_Style_Alignment::VERTICAL_CENTER);
      if (isset($productDataFields[$i])) {
        $sheet->setCellValueByColumnAndRow($i, $rowNum, lang('excel.shipment.product_table.header.' . $productDataFields[$i]));
      }
    }

    // Product table products
    $rowNum++;
    foreach ($productData as $p) {
      $sheet->mergeCellsByColumnAndRow(3, $rowNum, 4, $rowNum);
      foreach ($p as $k => $v) {
        for ($i=0; $i<=5; $i++) {
          $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
          $sheet->getStyleByColumnAndRow($i, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
          if ($i == array_search($k, $productDataFields)) {
            $sheet->setCellValueByColumnAndRow($i, $rowNum, $v);
          }
        }
      }
      $rowNum++;
    }

    // Send HTTP-headers
    header ( "Expires: Mon, 1 Apr 1974 05:00:00 GMT" );
    header ( "Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT" );
    header ( "Cache-Control: no-cache, must-revalidate" );
    header ( "Pragma: no-cache" );
    header ( "Content-type: application/vnd.ms-excel" );
    header ( "Content-Disposition: attachment; filename=MammyClub_на_клиента_" . $siteOrder['code'] . ".xls" );

    // Throw file to output
    $objWriter = new PHPExcel_Writer_Excel5($xls);
    $objWriter->save('php://output');
  }

	/**
	 * generate_order_shipmet_doc_on_confirmed_stock
	 * @param array $sitorderId
	 */
	public function generate_order_shipmet_doc($sitorderId) {

		$siteOrder = ManagerHolder::get('SiteOrder')->getById($sitorderId,'e.code');

		$file = ManagerHolder::get('SiteOrder')->genereteOrderShimpentDoc($sitorderId);

		// Send HTTP-headers
		header ( "Expires: Mon, 1 Apr 1974 05:00:00 GMT" );
		header ( "Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT" );
		header ( "Cache-Control: no-cache, must-revalidate" );
		header ( "Pragma: no-cache" );
		header ( "Content-type: application/vnd.ms-excel" );
		header ( "Content-Disposition: attachment; filename=MammyClub_на_клиента_" . $siteOrder['code'] . ".xls" );
		readfile($file);

		// Delete all generated files that are added to the archive
		array_map('unlink', glob('./web/uploads/siteorder/*'));

		die();

	}

  /**
   * generate_order_shipmet_doc_on_confirmed_stock
   * @param array $sitorderId
   */
  public function generate_order_shipmet_doc_on_confirmed_stock($sitorderId) {

	  $siteOrder = ManagerHolder::get('SiteOrder')->getById($sitorderId,'e.code');

	  $file = ManagerHolder::get('SiteOrder')->genereteOrderShimpentDocOnConfirmedStock($sitorderId);

	  // Send HTTP-headers
	  header ( "Expires: Mon, 1 Apr 1974 05:00:00 GMT" );
	  header ( "Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT" );
	  header ( "Cache-Control: no-cache, must-revalidate" );
	  header ( "Pragma: no-cache" );
	  header ( "Content-type: application/vnd.ms-excel" );
	  header ( "Content-Disposition: attachment; filename=" . $siteOrder['code'] . "_відвантаження.xls" );
	  readfile($file);

	  // Delete all generated files that are added to the archive
	  array_map('unlink', glob('./web/uploads/siteorder/*'));

	  die();
  }

  /**
   * generate_order_shipmet_doc_on_confirmed_stock
   * @param array $sitorderId
   */
  public function generate_order_shipmet_doc_on_confirmed_stock_old($sitorderId) {

    $siteOrder = ManagerHolder::get('SiteOrder')->getById($sitorderId, 'e.*, Cart.*');
    if (empty($siteOrder) || !isset($siteOrder['Cart'][0]['items']) || empty($siteOrder['Cart'][0]['items'])) {
      redirect_to_referral();
    }

    require_once('./lib/phpExcel/PHPExcel.php');
    require_once('./lib/phpExcel/PHPExcel/Writer/Excel5.php');

    $borderStyle = array('allborders' => array('style' => PHPExcel_Style_Border::BORDER_MEDIUM,
      'color' => array('rgb' => '000000')));

    $fontStyle = array('name' => 'Times New Roman', 'size' => 11);
    $fontBoldStyle = array_merge($fontStyle, array('bold' => true));

    $xls = new PHPExcel();
    $xls->setActiveSheetIndex(0);
    $sheet = $xls->getActiveSheet();
    $sheet->setTitle('Відвантаження');

    $sheet->getColumnDimension("B")->setWidth(20);
    $sheet->getColumnDimension("D")->setWidth(30);
    $sheet->getColumnDimension("E")->setWidth(13);

    $sheet->setCellValue("A1", 'Заявка на відвантаження товару');
    $sheet->getStyle('A1')->getFont()->applyFromArray($fontBoldStyle);
    $sheet->mergeCells('A1:F1');
    $sheet->getStyle('A1')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);

    $sheet->setCellValue("B2", '№ заявки:');
    $sheet->getStyle('B2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
    $sheet->getStyle('B2')->getFont()->applyFromArray($fontBoldStyle);

    $sheet->setCellValue("C2", $siteOrder['code']);
    $sheet->getStyle('C2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
    $sheet->getStyle('C2')->getFont()->applyFromArray($fontStyle);
    $sheet->getStyle('C2')->getBorders()->applyFromArray($borderStyle);

    $sheet->setCellValue("D2", 'Дата заявки:');
    $sheet->getStyle('D2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
    $sheet->getStyle('D2')->getFont()->applyFromArray($fontBoldStyle);

    $sheet->setCellValue("E2", date('Y-m-d'));
    $sheet->getStyle('E2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
    $sheet->getStyle('E2')->getFont()->applyFromArray($fontStyle);
    $sheet->getStyle('E2')->getBorders()->applyFromArray($borderStyle);

    // Order table
    $addressDelivery = $siteOrder['delivery_post'];
    if ($siteOrder['delivery_type'] == 'delivery-to-home') {
      $addressDelivery = $siteOrder['delivery_street'] . ', ' . $siteOrder['delivery_house'] . ', ' . $siteOrder['delivery_flat'];
    }
    $orderData = array('Замовник' => 'ФОП Пода (MammyClub.com)',
      'Перевізник' => 'Новая Почта',
      'Місто доставки' => $siteOrder['delivery_city'],
      'Адреса отримувача' => $addressDelivery,
      'ПІБ отримувача' => $siteOrder['fio'],
      'Телефон отримувача' => $siteOrder['phone'] . ' ',
      'Платник' => 'ФОП Пода',
      'Форма розрахунку' => 'Безготивкова',
      'Оголошена вартість вантажу' => $siteOrder['total'],
      'Внутрішній № замовлення' => $siteOrder['code'],
      'Сума післяплати товар' => $siteOrder['payment_type']=='cash'?$siteOrder['total']:'0',
      'Інші додаткові послуги' => 'нет',
      'ІПН Відправника' => '2845605576');

    $rowNum = 4;
    foreach ($orderData as $k => $v) {
      $sheet->mergeCellsByColumnAndRow(0, $rowNum, 1, $rowNum);
      $sheet->setCellValueByColumnAndRow(0, $rowNum, $k);
      $sheet->mergeCellsByColumnAndRow(2, $rowNum, 5, $rowNum);
      $sheet->setCellValueByColumnAndRow(2, $rowNum, $v);
      for ($i=2; $i<=5; $i++) {
        $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
      }
      $sheet->getStyleByColumnAndRow(2, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
      $rowNum++;
    }
    $rowNum++;

    // Product table
    $sheet->getRowDimension($rowNum)->setRowHeight('34,5');

    $productDataFields = array(0 => 'index', 1 => 'code', 2 => 'name', 4 => 'weight', 5 => 'qty');

    $productData = array();
    foreach ($siteOrder['Cart'][0]['items'] as $i => $cartItem) {
      $productName = $cartItem['product']['name'];
      $productCode = !empty($cartItem['product']['bar_code'])?$cartItem['product']['bar_code']:'';
      if (!empty($cartItem['additional_product_params'])) {
        $cartItem['additional_product_params'] = ManagerHolder::get('ParameterValue')->getAsViewArray(array(), 'name', null, array('id' => unserialize($cartItem['additional_product_params'])));
        $productName .= ' [' . implode(', ', $cartItem['additional_product_params']) . ']';
        // Check for parameter group by parameter values
        foreach ($cartItem['additional_product_params'] as $paramId => $paramName) {
          $paramGroup = ManagerHolder::get('ParameterGroup')->getOneWhere(array('product_id' => $cartItem['product_id'], 'main_parameter_value_id' => $paramId), 'e.*');
          if (!empty($paramGroup)) {
            $productCode = !empty($paramGroup['bar_code'])?$paramGroup['bar_code']:'';
            break;
          }
        }
      }
      $productData[] = array('index' => $i+1,
        'code'  => $productCode,
        'name'  => $productName,
        'qty'   => $cartItem['qty']);
    }
    // Product table header
    $sheet->mergeCellsByColumnAndRow(2, $rowNum, 3, $rowNum);
    for ($i=0; $i<=5; $i++) {
      $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
      $sheet->getStyleByColumnAndRow($i, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER)->setVertical(PHPExcel_Style_Alignment::VERTICAL_CENTER);
      if (isset($productDataFields[$i])) {
        $sheet->setCellValueByColumnAndRow($i, $rowNum, lang('excel.shipment.product_table_confirmed_stock.header.' . $productDataFields[$i]));
      }
    }

    // Product table products
    $rowNum++;
    foreach ($productData as $p) {
      $sheet->mergeCellsByColumnAndRow(2, $rowNum, 3, $rowNum);
      foreach ($p as $k => $v) {
        for ($i=0; $i<=5; $i++) {
          $sheet->getStyleByColumnAndRow($i, $rowNum)->getBorders()->applyFromArray($borderStyle);
          $sheet->getStyleByColumnAndRow($i, $rowNum)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
          if ($i == array_search($k, $productDataFields)) {
            $sheet->setCellValueByColumnAndRow($i, $rowNum, $v);
          }
        }
      }
      $rowNum++;
    }

    // Send HTTP-headers
    header ( "Expires: Mon, 1 Apr 1974 05:00:00 GMT" );
    header ( "Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT" );
    header ( "Cache-Control: no-cache, must-revalidate" );
    header ( "Pragma: no-cache" );
    header ( "Content-type: application/vnd.ms-excel" );
    header ( "Content-Disposition: attachment; filename=" . $siteOrder['code'] . "_відвантаження.xls" );

    // Throw file to output
    $objWriter = new PHPExcel_Writer_Excel5($xls);
    $objWriter->save('php://output');
  }

	/**
	 *  Load ajax popup view on siteorder
	 * @param $siteOrderId
	 */
	public function ajax_create_ttn($siteOrderId) {
    $siteOrder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*');

		$this->layout->setLayout('ajax');
		$this->layout->set('siteOrderId', $siteOrderId);
		$this->layout->set('siteOrder', $siteOrder);
		$this->layout->view('siteorder/ajax_create_ttn');
  }


  /**
   * @param $siteOrderId
   */
  public function create_ttn($siteOrderId) {
		$this->load->helper('common/itirra_ajax');

	  // Data from ajax popup
  	$data = array();
  	if (!empty($_POST)) {
		  foreach ($_POST as $key => $dataVal) {
			  $data[$key] = $dataVal;
		  }
	  }

  	$result = ManagerHolder::get('SiteOrder')->createTtn($siteOrderId, $data);
    if ($result['is_success'] == true) {
      set_flash_notice('ТТН успешно создана');
      uni_redirect(get_referrer(), true);
    } else {
      if (isset($result['erorrs'])) {
        set_flash_error($result['erorrs']);
      } elseif (isset($result['message'])) {
        set_flash_error($result['message']);
      }

      uni_redirect(get_referrer(), true);
    }
  }

  /**
   * @param $siteOrderId
   */
  public function send_ty_email($siteOrderId) {
    $result = ManagerHolder::get('TyBroadcast')->sendBySiteOrder($siteOrderId);

    if ($result['status'] == 'error') {
      set_flash_error($result['msg']);
    } else {
      set_flash_notice('Письмо успешно отправлено');
    }

    redirect_to_referral();
  }

  /**
   * Get address ajax
   */
  public function get_address_ajax() {
    if(!isset($_GET['city']) || empty($_GET['city'])) {
      show_404();
    }

    $city = ManagerHolder::get('City')->getById($_GET['city'], 'e.*');

    $this->load->library('NewPostSdk');
    $streets = $this->newpostsdk->searchStreet($city['ref'], $_GET['query']);

    die(json_encode($streets));
  }

 /**
   * Get address ajax
   */
  public function ajax_get_delivery_interval($date, $cityId) {
    if(empty($date) || empty($cityId)) {
      show_404();
    }

    $city = ManagerHolder::get('City')->getById($cityId, 'e.*');
    $date = strtotime($date);
    $date = date('d.m.Y', $date);

    $this->load->library('NewPostSdk');
    $intervals = $this->newpostsdk->getTimeIntervals($city['ref'], $date);
    foreach ($intervals as $k => $interval) {
      $intervals[$k] = array('id' => $interval->Number, 'name' => $interval->Start . ' - ' . $interval->End);
    }

    die(json_encode($intervals));
  }

  /**
   * Siteorder report
   */
  public function siteorder_report() {

    $this->setFilter();
    $where = $this->filters;

    $this->layout->set("backUrl", $this->adminBaseRoute . '/' .  strtolower($this->entityName));
    $this->layout->set("processLink", $this->adminBaseRoute . '/' .  strtolower($this->entityName) . '/siteorder_report_process');
    $this->layout->view('siteorder/report');
  }

  /**
   * Assemble
   */
  public function assemble() {
    $checkStatus = ManagerHolder::get('SiteOrderStatus')->getOneWhere(array('k' => 'is-completed'), 'e.*');
    $setStatus = ManagerHolder::get('SiteOrderStatus')->getOneWhere(array('k' => 'assembling-complete'), 'e.*');

    $siteOrders = ManagerHolder::get('SiteOrder')->getAllWhere(array('siteorder_status_id' => $checkStatus['id']), 'e.*');
    $k = 0;

    foreach ($siteOrders as $siteOrder) {
      $siteOrderItems = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteOrder['id']), 'e.*, reserves.*');
      $allReserved = TRUE;

      foreach ($siteOrderItems as $item) {
        if (empty($item['reserves'])) {
          $allReserved = FALSE;
          break;
        }
        $reservedZammler = 0;
        foreach ($item['reserves'] as $reserve) {
          if ($reserve['store_id'] == ZAMMLER_STORE_ID || $reserve['store_id'] == MC_STORE_ID) {
            $reservedZammler = $reserve['qty'];
          }
        }
        if ($reservedZammler < $item['qty']) {
          $allReserved = FALSE;
          break;
        }
      }

      if (!$allReserved) {
        continue;
      } else {
        $k++;
        ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'siteorder_status_id', $setStatus['id']);
      }
    }

    set_flash_notice('Заказов изменено: ' . $k);
    redirect_to_referral();
  }

  /**
   * Siteorder report
   */
  public function siteorder_report_process() {

    $this->load->helper('project');

    $fields = array('code', 'siteorder_status.name', 'product.category.name', 'product.brand.name', 'product.product_code', 'product.bar_code', 'product.name', 'additional_product_param', 'qty', 'product.cost_price', 'price', 'item_total', 'product.standard_store_qty', 'pregnancyweek', 'age_of_child', 'month_of_year');

    // Load CSV Library
    $this->load->library('common/csv');

    // Set headers
    $fTrans = array();
    foreach ($fields as $f) {
      $fTrans[] = lang('siteorder_report.header.' . $f);
    }
    $this->csv->addHeader($fTrans);

    $rows = array();

    $exportFilters = array();

    if (isset($_POST['batch_export_ids'])) {
      $exportFilters['id'] = explode(',', $_POST['batch_export_ids']);
    } else {

      // foreignKeys
      $foreignKeys = ManagerHolder::get($this->managerName)->getForeignKeys();
      $foreignKeysAliases = array();
      foreach($foreignKeys as $alias => $fk) {
        $foreignKeysAliases[$fk['local']] = $alias;
      }

      foreach ($this->filters as $k => $v) {
        if (isset($_GET[$k])) {
          $exportFilters[$k] = $_GET[$k];
          // company_id => company
          if($foreignKeysAliases && isset($foreignKeysAliases[$k])) {
            $k = $foreignKeysAliases[$k];
          }
          if (!in_array($k, $fields)) {
            $fields[] = $k;
          }
        }
      }

      if (!empty($_GET)) {
        foreach ($this->dateFilters as $key) {
          if (isset($_GET[$key . '_from']) && isset($_GET[$key . '_to'])) {
            $exportFilters[$key . 'BETWEEN'] = $_GET[$key . '_from'] . ' 00:00:00' . ' AND ' . $_GET[$key . '_to'] . ' 23:59:59';
          } else {
            if (isset($_GET[$key . '_from'])) {
              $exportFilters[$key . '>='] = $_GET[$key . '_from'] . ' 00:00:00';
            }
            if (isset($_GET[$key . '_to'])) {
              $exportFilters[$key . '<='] = $_GET[$key . '_to'] . ' 23:59:59';
            }
          }
        }
      }
    }

    if (!empty($this->extraWhere)) {
      $exportFilters = array_merge($exportFilters, $this->extraWhere);
    }

    if (!empty($exportFilters)) {
      $orders = ManagerHolder::get($this->managerName)->getAllWhere($exportFilters, 'e.*, items.*, user.*, siteorder_status.*');
    } else {
      // Get everything from DB
      $orders = ManagerHolder::get($this->managerName)->getAllWhere(array(), 'e.*, items.*, user.*, siteorder_status.*');
    }

    if(!empty($orders)) {

      $allPossibleProductParameterValues = ManagerHolder::get('ParameterValue')->getAll('id, name');
      $allPossibleProductParameterValuesIDs = get_array_vals_by_second_key($allPossibleProductParameterValues, 'id');

      foreach ($orders as $o) {

        foreach ($o['items'] as $cartItem) {

          $row = array();

          foreach ($fields as $f) {
            $row[$f] = '';
            if ($f == 'product.bar_code') {
              if (!empty($cartItem['parameter_group']) && isset($cartItem['parameter_group']['bar_code'])) {
                $row[$f] = $cartItem['parameter_group']['bar_code'];
              } else {
                $row[$f] = $cartItem['product']['bar_code'];
              }
              continue;
            }
            if ($f == 'product.standard_store_qty') {
              if (!empty($cartItem['parameter_group']) && isset($cartItem['parameter_group']['standard_store_qty'])) {
                $row[$f] = $cartItem['parameter_group']['standard_store_qty'];
              } else {
                $row[$f] = $cartItem['product']['standard_store_qty'];
              }
              continue;
            }
            if($f == 'code') {
              $row[$f] = $o[$f];
              continue;
            }
            if($f == 'siteorder_status.name') {
              $row[$f] = $o['siteorder_status']['name'];
              continue;
            }
            if($f == 'additional_product_param') {
              if(!empty($cartItem['additional_product_params'])) {
                $cartItem['additional_product_params'] = unserialize($cartItem['additional_product_params']);
                $paramValueID = array_pop($cartItem['additional_product_params']);
                $paramValueKey = array_search($paramValueID, $allPossibleProductParameterValuesIDs);
                $row[$f] = $allPossibleProductParameterValues[$paramValueKey]['name'];
              }
              continue;
            }
            if($f == 'pregnancyweek') {
              if(!empty($o['user']['pregnancyweek_current'])) {
                $row[$f] = $o['user']['pregnancyweek_current']['number'];
              }
              continue;
            }
            if($f == 'age_of_child') {
              $row[$f] = $o['user']['age_of_child'];
              continue;
            }
            if($f == 'month_of_year') {
              $row[$f] = lang('month.' . date('n', strtotime($o['created_at'])));
              continue;
            }
            if(strpos($f, '.') !== FALSE) {
              $row[$f] = get_nested_array_value_by_key_with_dots($cartItem, $f);
            } else {
              $row[$f] = $cartItem[$f];
            }
          }

          $rows[] = $row;
        }
      }
    }

    $this->csv->addRows($rows);
    $fileName = 'siteorder_report_' . date('Y-m-d') . '.csv';
    $this->csv->flushFile($fileName);

    die('old version');
    $params = get_get_params();
    $params .= !empty($params)?'&':'?';
    $params .= 'toemail=' . $_POST['email'];

    $url = site_url('siteorder_report/30ad3a3a1d2c7c63102e09e6fe4bb253' . $params);
    send_curl_request($url);

    set_flash_notice('Операция прошла успешно');
    redirect_to_referral();
  }

  /**
   * preview
   * @param int $id
   */
  public function preview($id) {


    $manager = ManagerHolder::get($this->managerName);

    $e = $manager->getById($id, 'e.*, shipment_store.name, manager.name, delivery_city.name, delivery_warehouse.name');
    $cart = $this->getSiteorderCartWithItems($e['id']);

    $this->layout->set('fields', $this->fields);
    $this->layout->set('e', $e);
    $this->layout->set('cart', $cart);
    $this->layout->set('entityName', strtolower($this->entityName));

    $this->layout->view('siteorder_preview');
  }

  /**
   * CreateEntityId.
   * Creates Entity By Id;
   * @param integer $entityId
   * @return Object
   */
  protected function createEntityId($entityId = null) {
    $entity = new $this->managerName;
    $entityObject = $entity;
    $entity = $entity->toArray();
    if ($entityId) {
      $params = "id,blocked_admin_id,";
      foreach ($this->fields as $k => $v) {
        $params .= $k . ",";
      }
      if (in_array('can_be_deleted', array_keys($entity))) {
        $params .= "can_be_deleted";
      }
      $params = rtrim($params, ',');
      ManagerHolder::get($this->managerName)->clearCacheGroup();
      $entity = ManagerHolder::get($this->managerName)->getById($entityId, $params);
      if (empty($entity)) {
        redirect($this->adminBaseRoute . '/' .  strtolower($this->entityUrlName));
      }
    }
    // Check for other admin in order
    if(!empty($entity)) {
      $currentAdmin = $this->session->userdata('LOGGED_IN_ADMIN_SESSION_KEY');
      if(!empty($entity['blocked_admin_id']) && $entity['blocked_admin_id'] != $currentAdmin['id']) {
        $blockedAdmin = ManagerHolder::get('Admin')->getById($entity['blocked_admin_id'], 'e.*');
        set_flash_error('С данным заказом уже работает админ ' . $blockedAdmin['email']);
        redirect(admin_site_url('siteorder'));
      }
      ManagerHolder::get('SiteOrder')->updateById($entity['id'], 'blocked_admin_id', $currentAdmin['id']);
    }
    return $entity;
  }

  /**
   * SetAddEditDataAndShowView.
   * Set all needed view data and show add_edit form.
   * @param object $entity
   */
  protected function setAddEditDataAndShowView($entity) {

    $this->load->helper('project');

    // Set statuses
    $siteOrderStatuses = ManagerHolder::get('SiteOrderStatus')->getAll('e.*');
    $this->layout->set("siteOrderStatuses", $siteOrderStatuses);

    $this->preProcessFields($entity);

    $cart = $this->getSiteorderCartWithItems($entity['id']);

    if (!empty($entity['user'])) {
      $user = ManagerHolder::get('User')->getById($entity['user'], 'e.*');
    }

    $this->layout->setLayout('empty');

    $this->fields['cart_items_data'] = array('type'=> 'html');
    $siteOrderStatus = ManagerHolder::get('SiteOrderStatus')->getById($cart['siteorder']['siteorder_status_id'], 'e.*');
    // Cart data table
    $this->layout->set('cart', $cart);
    $this->layout->set('siteOrderStatus', $siteOrderStatus);

    $entity['cart_items_data'] = $this->layout->view('siteorder/cart', TRUE);

    // Add product block TODO should be refactored into separate ajax call
    $products = ManagerHolder::get('Product')->getAll('id, price, name');
    $this->layout->set('products', $products);
    $entity['cart_items_data'] .= $this->layout->view('siteorder/add_to_cart', TRUE);

    // Cut inv_channel fields and past to the end
    $tempFields = array();
    foreach ($this->fields as $k => $v) {
      if(strpos($k, 'inv_channel') !== FALSE) {
        $tempFields[$k] = $v;
        unset($this->fields[$k]);
      }
    }
    if(!empty($tempFields)) {
      $this->fields = array_merge($this->fields, $tempFields);
    }

    // Check user's inv_channel fields
    if(isset($user)) {
      $this->fields['user_inv_data'] = array('type'=> 'html');
      $entity['user_inv_data'] =  '<ul>';
      $entity['user_inv_data'] .= '<li>Канал привлечения подписки:' . $user['inv_channel'] .'</li>';
      $entity['user_inv_data'] .= '<li>current.src подписки:' . $user['inv_channel_src'] .'</li>';
      $entity['user_inv_data'] .= '<li>current.mdm подписки:' . $user['inv_channel_mdm'] .'</li>';
      $entity['user_inv_data'] .= '<li>current.cmp подписки:' . $user['inv_channel_cmp'] .'</li>';
      $entity['user_inv_data'] .= '<li>current.cnt подписки:' . $user['inv_channel_cnt'] .'</li>';
      $entity['user_inv_data'] .= '<li>current.trm подписки:' . $user['inv_channel_trm'] .'</li>';
      $entity['user_inv_data'] .= '</ul>';
    }

    $this->layout->set("fields", $this->fields);
    $pageNum = ManagerHolder::get($this->managerName)->getEntityPageNum($entity['id'], $this->perPage);
    $backUrl = $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName . ($pageNum > 1 ? ('/' . $this->config->item('page_prefix') . $pageNum) : '' ) . get_get_params());
    $this->layout->set("backUrl", $backUrl);
    if (!empty($entity['id'])) {
      $this->layout->set("nextUrl", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/next/' . $entity['id'] . '/' . get_get_params());
      $this->layout->set("prevUrl", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/prev/' . $entity['id'] . '/' . get_get_params());
    }
    $this->layout->set("processLink", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/add_edit_process');
    $this->preAddEditView($entity);
    $this->layout->set("entity", $entity);
    $this->layout->set("actions", $this->actions);
    $this->layout->set("print", $this->print);
    $this->layout->setLayout('admin');
    $this->layout->view('add_edit_siteorder');
  }

  /**
   * getSiteorderCartWithItems
   * @param int $siteOrderId
   */
  private function getSiteorderCartWithItems($siteOrderId) {

    $cart = array();
    $cart['siteorder'] = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, delivery.*');
    $cart['items'] = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteOrderId), 'e.*, product.*, parameter_group.*');

	  if (isset($cart['items']) && !empty($cart['items'])) {
      foreach ($cart['items'] as &$cartItem) {

        // Add supplier request item
        $cartItem['supplier_request_item'] = ManagerHolder::get('SupplierRequestProductParameterGroup')->getOneWhere(array('siteorder_item_id' => $cartItem['id']), 'e.*, supplier_request.*');

        // Add product
        $cartItem['product'] = ManagerHolder::get('Product')->getById($cartItem['product_id'], 'e.*, brand.*');



        // Add selected by user parameters
        if (!empty($cartItem['additional_product_params'])) {
          $cartItem['additional_product_params'] = unserialize($cartItem['additional_product_params']);
        }

        // Add item parameter group
        if (!empty($cartItem['parameter_group_id'])) {
          $cartItem['parameter_group'] = ManagerHolder::get('ParameterGroup')->getById($cartItem['parameter_group_id'], 'e.*');
        }

        // Get possible parameters
        $cartItem['product']['possible_parameters'] = ManagerHolder::get('ParameterProduct')->getById($cartItem['product']['possible_parameters_id'], 'e.*, parameter_main.*, parameter_secondary.*, possible_parameter_values.*');

        // Get parameter groups of the product
        $cartItem['product']['parameter_groups'] = ManagerHolder::get('ParameterGroup')->getAllWhere(array('product_id' => $cartItem['product']['id']), 'e.*, main_parameter_value.*, secondary_parameter_values_out.*, image.*');
        if(!empty($cartItem['product']['parameter_groups'])) {
          foreach ($cartItem['product']['parameter_groups'] as &$group) {

            $secondaryParamValueIds = get_array_vals_by_second_key($group['secondary_parameter_values_out'], 'id');

            $group['secondary_parameter_values'] = array();
            foreach ($cartItem['product']['possible_parameters']['possible_parameter_values'] as $possibleParamValue) {
              if($cartItem['product']['possible_parameters']['parameter_secondary_id'] == $possibleParamValue['parameter_id']) {
                $possibleParamValue['not_in_stock'] = FALSE;
//                if(in_array($possibleParamValue['id'], $secondaryParamValueIds) || $group['not_in_stock'] == TRUE) {
//                  $possibleParamValue['not_in_stock'] = TRUE;
//                }
                $group['secondary_parameter_values'][] = $possibleParamValue;
              }
            }
          }
        }

	      // Set delivery time
	      $cartItem['delivery_time'] = '';
	      if (!empty($cartItem['zammler_inventory_qty']) || !empty($cartItem['mc_inventory_qty'])){
		      $cartItem['delivery_time'] = "Есть на складе";
	      } elseif (!empty($cartItem['other_stores_inventory_qty'])){
		      $cartItem['delivery_time'] = $cartItem['product']['brand']['delivery_time'];
	      }
        // Add all available parameters
        if (isset($cartItem['product']['product_params_id']) && !empty($cartItem['product']['product_params_id'])) {
          $cartItem['product']['params'] = ManagerHolder::get('ProductParams')->getById($cartItem['product']['product_params_id'], 'e.*');
          $cartItem['product']['params'] = unserialize($cartItem['product']['params']['product_params']);
        }

        $cartItem['reserves'] = ManagerHolder::get('StoreReserve')->getOneWhere(array('siteorder_item_id' => $cartItem['id'], 'store_id' => $cart['siteorder']['shipment_store_id']), 'e.*');
      }
    }

    return $cart;
  }

  /**
   * Add edit
   * @param null $entityId
   */
  public function add_edit($entityId = null) {
    $siteOrder = ManagerHolder::get('SiteOrder')->getById($entityId, 'id, shipment_store_id');

    $supplierNewRequests = ManagerHolder::get('SupplierRequest')->getAllWhere(array('supplier_request_status_id' => 1, 'receiver_id' => $siteOrder['shipment_store_id']), 'e.*');
    $this->layout->set("supplierNewRequests", $supplierNewRequests);

    // Add stores
    $stores = ManagerHolder::get('Store')->getAsViewArray();
    $this->layout->set('stores', $stores);

    parent::add_edit($entityId);
  }

  /**
   * Add Edit process.
   */
  public function add_edit_process() {
    $this->processTyBroadcast();
    $this->processOrderBroadcast();
    if (isset($_POST['send_order_confirmed_broadcast']) && !empty($_POST['send_order_confirmed_broadcast'])) {
      ManagerHolder::get('OrderConfirmedBroadcast')->sendBySiteOrder($_POST['id']);
    }
    $entity = $this->createEntityPOST();
    $this->processOrderDiscount($entity);
    $this->loadAndResizeImages($entity);
    $this->loadFiles($entity);
    $this->loadVideos($entity);
    $entity = $this->addEditEntity($entity);
    if (isset($_POST['save_and_return_to_list'])) {
      ManagerHolder::get($this->managerName)->updateById($entity['id'], 'blocked_admin_id', NULL);
      $pageNum = ManagerHolder::get($this->managerName)->getEntityPageNum($entity['id'], $this->perPage);
      redirect($this->adminBaseRoute . '/' .  strtolower($this->entityUrlName . ($pageNum > 1 ? ('/' . $this->config->item('page_prefix') . $pageNum) : '' ) . get_get_params()));
    }
    $this->redirectToReffer($entity['id']);
  }

	/**
	 * @param $broadcastType
	 * @return bool
	 */
  public function ajax_process_broadcast($broadcastType) {
    if ($broadcastType == 'order_confirmed') {
      if (isset($_POST['id']) && !empty($_POST['id'])) {
        ManagerHolder::get('OrderConfirmedBroadcast')->sendBySiteOrder($_POST['id']);
      }
      return TRUE;
    }

    if (empty($_POST['user'])) {
      return false;
    }

    if ($broadcastType == 'order') {
      $this->processOrderBroadcast();
    } elseif ($broadcastType == 'ty') {
      $this->processTyBroadcast();
    }
  }

  /**
   * Process order discount
   * @param $entity
   */
  private function processOrderDiscount($entity) {
    $update = array();
    if (isset($_POST['total_discount'])) {
      $siteOrder = ManagerHolder::get('SiteOrder')->getById($entity['id'], 'total, delivery_price');

	    $update['total_discount'] = $_POST['total_discount'];
      $update['total_with_discount'] = $siteOrder['total'] - $_POST['total_discount'];
      $update['total_with_discount'] += $siteOrder['delivery_price'];

      ManagerHolder::get('SiteOrder')->updateAllWhere(array('id' => $entity['id']), $update);
    } else {
	    $siteOrder = ManagerHolder::get('SiteOrder')->getById($entity['id'], 'total, total_with_discount, delivery_price, total_discount');

      $total = $siteOrder['total'];
      $total += $siteOrder['delivery_price'];
      if (!empty($siteOrder['total_discount'])) {
        $total -= $siteOrder['total_discount'];
      }
      ManagerHolder::get('SiteOrder')->updateById($entity['id'], 'total_with_discount', $total);
    }
  }

  /**
   * Process Ty Broadcast
   */
  private function processTyBroadcast() {
    if (isset($_POST['send_ty_broadcast'])) {
      $broadcast = ManagerHolder::get('TyBroadcast')->getAll('e.*');
      if (empty($broadcast)) {
        return false;
      }
      $broadcast = $broadcast[0];

      $siteorder = ManagerHolder::get('SiteOrder')->getById($_POST['id'], 'e.*, Cart.*');
      $user = ManagerHolder::get('User')->getById($_POST['user'], 'e.*, auth_info.*, pregnancyweek_current.*');
      if (empty($user)) {
        return false;
      }
      $user['name'] = $_POST['send_ty_broadcast'];
      unset($_POST['send_ty_broadcast']);

      $this->load->helper('project');

      // Create MandrillBroadcast
      $broadcastData = array('subject' => $broadcast['subject'],
                             'text' => '',
                             'recipients_count' => 1,
                             'read_count' => 0,
                             'link_visited_count' => 0,
                             'created_at' => date(DOCTRINE_DATE_FORMAT),
                             'type' => TY_BROADCAST);

      $broadcastId = ManagerHolder::get('MandrillBroadcast')->insert($broadcastData);

      // Collect data to array
      $viewData = ManagerHolder::get('TyBroadcast')->createFirstYearBroadcastContent($broadcast, $user);

      // Save Broadcast Links
      foreach ($viewData as $data) {
        if (!empty($data)) {
          ManagerHolder::get('MandrillBroadcast')->saveBroadcastLinks($data, $broadcastId);
        }
      }

      // Insert recipient data
      $userData = array('email' => $siteorder['email'],
                        'user_id' => $user['id'],
                        'is_read' => 0,
                        'is_send' => 0,
                        'data' => serialize($user),
                        'broadcast_id' => $broadcastId,
                        'updated_at' => date(DOCTRINE_DATE_FORMAT));
      $recipientId = ManagerHolder::get('MandrillBroadcastRecipient')->insert($userData);

      try {
        $metaData = array('broadcast_id' => $broadcastId,
                          'recipient_id' => $recipientId);
        ManagerHolder::get('EmailMandrill')->setMetadata($metaData);
        ManagerHolder::get('EmailMandrill')->sendTemplate($userData['email'], 'ty_broadcast/view', $viewData, $viewData['subject']);
        log_message('debug', '[send_ty_broadcast_single] - Email sent to ' . $userData['email'] . '; Subject: ' . $viewData['subject']);

        ManagerHolder::get('MandrillBroadcast')->updateById($broadcastId, 'sent_date', date(DOCTRINE_DATE_FORMAT));
        ManagerHolder::get('SiteOrder')->updateById($siteorder['id'], 'request_review', TRUE);
      } catch (Exception $e) {
        log_message('error', '[send_ty_broadcast_single] - Broadcast send error:' . $e->getMessage() . '; on email: ' . $user['auth_info']['email']);
      }

      ManagerHolder::get('EmailNotice')->sendNoticeAboutBroadcastEnd(TY_BROADCAST, 1);
    }
  }

  /**
   * Process Order Broadcast
   */
  private function processOrderBroadcast() {
    if (isset($_POST['send_order_broadcast'])) {

      $tempPost = array('fio' => $_POST['fio'],
                        'ttn_code' => $_POST['ttn_code'],
                        'phone' => $_POST['phone']);

      $broadcast = ManagerHolder::get('OrderBroadcast')->getAll('e.*');
      if (empty($broadcast)) {
        return false;
      }
      $broadcast = $broadcast[0];

      ManagerHolder::get('SiteOrder')->updateById($_POST['id'], 'ttn_code', $tempPost['ttn_code']);
      $siteorder = ManagerHolder::get('SiteOrder')->getById($_POST['id'], 'e.*, Cart.*, delivery.*');
      if (empty($siteorder)) {
        return false;
      }
      foreach ($tempPost as $k => $f) {
        if (isset($_POST['order_' . $k])) {
          $siteorder[$k] = $_POST['order_' . $k];
          $_POST[$k] = $_POST['order_' . $k];
        }
      }

      $user = ManagerHolder::get('User')->getById($_POST['user'], 'e.*, auth_info.*');
      if (empty($user)) {
        return false;
      }
      $user['name'] = $_POST['fio'];

      $this->load->helper('project');

      // Create MandrillBroadcast
      $broadcastData = array('subject' => kprintf($broadcast['subject'], $_POST),
                             'text' => '',
                             'recipients_count' => 1,
                             'read_count' => 0,
                             'link_visited_count' => 0,
                             'created_at' => date(DOCTRINE_DATE_FORMAT),
                             'type' => ORDER_BROADCAST);

      $broadcastId = ManagerHolder::get('MandrillBroadcast')->insert($broadcastData);

      // Collect data to array
      $viewData = ManagerHolder::get('OrderBroadcast')->createBroadcastContent($broadcast, $user, $siteorder);

      // Save Broadcast Links
      foreach ($viewData as &$data) {
        if (!empty($data)) {
          ManagerHolder::get('MandrillBroadcast')->saveBroadcastLinks($data, $broadcastId);
        }
      }

      // Insert recipient data
      $userData = array('email' => $siteorder['email'],
                        'user_id' => $user['id'],
                        'is_read' => 0,
                        'is_send' => 0,
                        'data' => serialize($user),
                        'broadcast_id' => $broadcastId,
                        'updated_at' => date(DOCTRINE_DATE_FORMAT));
      $recipientId = ManagerHolder::get('MandrillBroadcastRecipient')->insert($userData);

      try {
        $metaData = array('broadcast_id' => $broadcastId,
                          'recipient_id' => $recipientId);
        ManagerHolder::get('EmailMandrill')->setMetadata($metaData);
        ManagerHolder::get('EmailMandrill')->sendTemplate($userData['email'], 'order_broadcast/view', $viewData, $viewData['subject']);
        log_message('debug', '[send_order_broadcast_single] - Email was sent to ' . $userData['email']. '; Subject: ' . $viewData['subject']);

        ManagerHolder::get('MandrillBroadcast')->updateById($broadcastId, 'sent_date', date(DOCTRINE_DATE_FORMAT));
      } catch (Exception $e) {
        log_message('error', '[send_order_broadcast_single] - Broadcast send error:' . $e->getMessage() . '; on email: ' . $user['auth_info']['email']);
      }

      ManagerHolder::get('EmailNotice')->sendNoticeAboutBroadcastEnd(ORDER_BROADCAST, 1);

      // Send SMS to user
      if (isset($_POST['phone']) && !empty($_POST['phone'])) {
        $smsMsg = $_POST['fio'] . ', Ваш заказ отправлен. ТТН ' . $_POST['ttn_code'];
        ManagerHolder::get('SMS')->sendMessage($_POST['phone'], str_replace(' ', '+', $smsMsg));
        log_message('debug', '[send_order_broadcast_single] - SMS was sent to: ' . $_POST['phone']);
      }

      foreach ($tempPost as $k => $f) {
        $_POST[$k] = $f;
      }
    }
  }

  /**
   * getRefUriString
   */
  private function getRefUriString() {
    $section = str_replace(admin_site_url(''), '', $_SERVER['HTTP_REFERER']);
    if(strpos($section, '?') !== FALSE) {
      $sectionArr = explode('?', $section);
      $section = $sectionArr[0];
    }
    return $section;
  }

  /**
   * admin_activity_tracking.
   */
  public function ajax_admin_activity_tracking() {
    if(!empty($this->loggedInAdmin)) {
      $updateArr = array('last_section_visited' => $this->getRefUriString(),
                         'last_activity_date'   => date(DOCTRINE_DATE_FORMAT));
      ManagerHolder::get('Admin')->updateAllWhere(array('id' => $this->loggedInAdmin['id']), $updateArr);
    }
  }

  /**
   * ajax_check_activity.
   */
  public function ajax_check_activity() {
    if(!empty($this->loggedInAdmin)) {
      $section = $this->getRefUriString();
      $where = array('last_section_visited'  => $section,
                     'last_activity_date >=' => date(DOCTRINE_DATE_FORMAT, time() - 20));
      $otherAdminsInThisSection = ManagerHolder::get('Admin')->getAllWhere($where, 'id, email', null, array($this->loggedInAdmin['id']));
      die(json_encode($otherAdminsInThisSection));
    }
  }

	/**
	 * @param $id
	 * @param $broadcastType
	 */
  public function ajax_check_broadcast_send($id, $broadcastType) {
    $entity = ManagerHolder::get($this->entityName)->getById($id, 'e.*');
    if (empty($entity)) {
      show_404();
    }
    $this->layout->setLayout('ajax');
    $this->layout->set('siteorder', $entity);
    $this->layout->view('siteorder/ajax_check_' . $broadcastType . '_broadcast_send');
  }

	/**
	 * @param $id
	 */
  public function ajax_check_order_shipmet_doc($id) {
    $entity = ManagerHolder::get($this->entityName)->getById($id, 'e.*, siteorder_status.*');
    if (empty($entity)) {
      show_404();
    }
    $this->layout->setLayout('ajax');
    $this->layout->set('siteorder', $entity);
    $this->layout->view('siteorder/ajax_check_order_shipment_doc');
  }

	/**
	 * Export.
	 */
	public function export() {
		$this->fields['complete_status_date'] = array('type' => 'datetime');
		parent::export();
	}

  /**
   * Export process.
   */
  public function export_process() {
    if (!$this->export) show_404();

    $entityObject = new $this->entityName;

    $_POST = array_make_plain_with_dots($_POST);

	  $this->fields['complete_status_date'] = array('type' => 'datetime');

    $fields = array();
    if (!isset($this->fields['id'])) {
      $fields = array('id');
    }

    foreach ($this->fields as $k => $v) {
      if (!isset($_POST[$k]) || $_POST[$k] == 0) continue;
      $fields[] = $k;
    }

    // Export filters
    $exportFilters = array();

    if (isset($_POST['exportfilter_batch_export_ids'])) {
      $exportFilters['id'] = explode(',', $_POST['exportfilter_batch_export_ids']);
    } else {

      // foreignKeys
      $foreignKeys = ManagerHolder::get($this->managerName)->getForeignKeys();
      $foreignKeysAliases = array();
      foreach($foreignKeys as $alias => $fk) {
        $foreignKeysAliases[$fk['local']] = $alias;
      }

      foreach ($this->filters as $k => $v) {
        $key = 'exportfilter_' . str_replace('.', '_', $k);
        if (isset($_POST[$key])) {
          $exportFilters[$k] = $_POST[$key];
          // company_id => company
          $k = str_replace('.', '_', $k);
          if($foreignKeysAliases && isset($foreignKeysAliases[$k])) {
            $k = $foreignKeysAliases[$k];
          }
          if (!in_array($k, $fields)) {
            $fields[] = $k;
          }
        }
      }

      foreach ($this->dateFilters as $k) {
        $key = 'exportfilter_' . str_replace('.', '_', $k);
        if (isset($_POST[$key])) {
          if (strpos($_POST[$key], 'BETWEEN') !== FALSE) {
            $exportFilters[$k . 'BETWEEN'] = trim(str_replace('BETWEEN', '', $_POST[$key]));
          }
          if (strpos($_POST[$key], '>') !== FALSE) {
            $exportFilters[$k . '>='] = trim(str_replace('>', '', $_POST[$key])) . ' 00:00:00';
          }
          if (strpos($_POST[$key], '<') !== FALSE) {
            $exportFilters[$k . '<='] = trim(str_replace('<', '', $_POST[$key])) . ' 23:59:59';
          }
          // company_id => company
          if($foreignKeysAliases && isset($foreignKeysAliases[$k])) {
            $k = $foreignKeysAliases[$k];
          }
          if (!in_array($k, $fields)) {
            $fields[] = $k;
          }
        }
      }
    }

    if (!empty($this->extraWhere)) {
      $exportFilters = array_merge($exportFilters, $this->extraWhere);
    }

    $entitiesFields = $fields;
    $entitiesFields[] = 'total_on_create';
	  $entitiesFields[] = 'total_with_discount';
	  if (!empty($exportFilters)) {
      $entities = ManagerHolder::get($this->managerName)->export($exportFilters, $entitiesFields);
    } else {
      // Get everything from DB
      $entities = ManagerHolder::get($this->managerName)->export(array(), $entitiesFields);
    }

    $entityObject = new $this->entityName;

    // Load CSV Library
    $this->load->library('common/csv');

    if (!isset($_POST['id']) || empty($_POST['id'])) {
      unset($fields[array_search('id', $fields)]);
    }

    // Set headers
    $ftrans = array();
    $fields[] = 'user_inv_channel';
    $fields[] = 'user_inv_channel_src';
    $fields[] = 'user_inv_channel_mdm';
    $fields[] = 'user_inv_channel_cmp';
    $fields[] = 'user_inv_channel_cnt';
    $fields[] = 'user_inv_channel_trm';


    foreach ($fields as $f) {
      $ftrans[] = html_entity_decode(lang('admin.add_edit.' . strtolower($this->entityName) . '.' .  str_replace('.*', '', $f)));
    }
    $ftrans[] = 'Сумма на момент создания';
    $ftrans[] = 'Сумма';

    $this->csv->addHeader($ftrans);
    if ($entities) {

      // Get all carts
      $carts = array();
      $soIds = get_array_vals_by_second_key($entities, 'id');
      $tempCarts = ManagerHolder::get('Cart')->getAllWhere(array('siteorder_id' => $soIds), 'e.*');
      if(!empty($tempCarts)) {
        foreach ($tempCarts as $tc) {
          if(!isset($carts[$tc['siteorder_id']])) {
            $carts[$tc['siteorder_id']] = $tc;
          }
        }
      }

      // Get all users
      $users = ManagerHolder::get('User')->getAllWhere(array('orders.id' => $soIds), 'id, inv_channel, inv_channel_src, inv_channel_mdm, inv_channel_cmp, inv_channel_cnt, inv_channel_trm');
      foreach ($users as &$u) {
        $orderIds = array();
        foreach ($u['orders'] as $o) {
          $orderIds[] = $o['id'];
        }
        $u['orders'] = $orderIds;
      }

      // Process Rows
      $rows = array();
      foreach ($entities as $e) {

        // Process user_inv_data
        $e['user_inv_channel']  = '';
        $e['user_inv_channel_src']  = '';
        $e['user_inv_channel_mdm']  = '';
        $e['user_inv_channel_cmp']  = '';
        $e['user_inv_channel_cnt']  = '';
        $e['user_inv_channel_trm']  = '';
        foreach ($users as $u) {
          if(in_array($e['id'], $u['orders'])) {
            $e['user_inv_channel']  = $u['inv_channel'];
            $e['user_inv_channel_src']  = $u['inv_channel_src'];
            $e['user_inv_channel_mdm']  = $u['inv_channel_mdm'];
            $e['user_inv_channel_cmp']  = $u['inv_channel_cmp'];
            $e['user_inv_channel_cnt']  = $u['inv_channel_cnt'];
            $e['user_inv_channel_trm']  = $u['inv_channel_trm'];
            break;
          }
        }

        $row = array();
        foreach ($fields as $key) {
          $row[$key] = $e[$key];
        }
        // Process cart total
//        if(isset($carts[$e['id']])) {
//          $row[] = $carts[$e['id']]['total'];
//        }
	      $row[] = (int)$e['total_on_create'];
	      $row[] = (int)$e['total_with_discount'];
	      $row = $this->preProcessExportRow($row, $fields);
        $rows[] = $row;
      }
      $this->csv->addRows($rows);
    }

    // Send file to output
    $this->csv->flushFile(lang('admin.entity_list.' . strtolower($this->entityName) . '.list_title') . '.csv');
    die();
  }

  /**
   * Change status AJAX
   */
  public function change_status() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $statusId = $_GET['vl'];
    $newstatus = 'ok';
    $smsview = '';

    $siteOrderStatus = ManagerHolder::get('SiteOrderStatus')->getById($statusId, 'e.*');
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, siteorder_status.*, blocked_admin.*');
    if (empty($siteorder)) {
      die('ERROR2');
    }
    if (!empty($siteorder['siteorder_status']) && $siteorder['siteorder_status']['k'] == SITEORDER_STATUS_CANCELED) {
      $message = array('status' => 'busy', 'message' => 'Нельзя изменить статус, заказ был отменен');
      $data = json_encode($message);
      die($data);
    }
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    if (($siteOrderStatus['k'] == SITEORDER_STATUS_CLIENT_CONFIRMED || $siteOrderStatus['k'] == 'payment_pending') && (empty($siteorder['shipment_store_id']) || empty($siteorder['shipment_date']))) {
      $message = array('status' => 'busy', 'message' => 'Не указан склад отгрузки или дата отгрузки');
      $data = json_encode($message);
      die($data);
    }
    if ($siteOrderStatus['k'] == 'send-to-delivery' || $siteOrderStatus['k'] == 'assembling-complete') {
      if ($siteorder['shipment_store_id'] == ZAMMLER_STORE_ID || $siteorder['shipment_store_id'] == MC_STORE_ID) {
        $siteOrderItems = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteorder['id']), 'e.*, reserves.*');

        foreach ($siteOrderItems as $item) {
          if (empty($item['reserves'])) {
            $message = array('status' => 'busy', 'message' => 'Не все товары в заказе забронированы');
            $data = json_encode($message);
            die($data);
          }
          $reservedZammler = 0;
          foreach ($item['reserves'] as $reserve) {
            if ($reserve['store_id'] == ZAMMLER_STORE_ID || $reserve['store_id'] == MC_STORE_ID) {
              $reservedZammler = $reserve['qty'];
            }
          }
          if ($reservedZammler < $item['qty']) {
            $message = array('status' => 'busy', 'message' => 'Не все товары в заказе забронированы');
            $data = json_encode($message);
            die($data);
          }
        }
      }
    }

    if ($statusId == 'NULL') {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'siteorder_status_id', null);
    } else {
      $status = ManagerHolder::get('SiteOrderStatus')->getById($statusId, 'e.*');
      if (empty($status)) {
        die('ERROR3');
      }
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'siteorder_status_id', $statusId);
      $this->layout->setLayout('ajax');
      $templates = array();
//      if ($status['k'] == SITEORDER_STATUS_WAIT) {
//        $templates = ManagerHolder::get('SmsTemplate')->getAllWhere(array('type' => SMS_TEMPLATE_PAYMENT), 'e.*');
//        $smsview = $this->layout->render('includes/admin/siteorder/smssend', array('templates' => $templates, 'order' => $siteorder), TRUE);
//      }
//       if ($status['k'] == SITEORDER_STATUS_SHIPPED) {
//         $templates = ManagerHolder::get('SmsTemplate')->getAllWhere(['type' => SMS_TEMPLATE_TTN], 'e.*');
//         $smsview = $this->layout->render('includes/admin/siteorder/smssend', array('templates' => $templates, 'order' => $siteorder), TRUE);
//       }
      if ($status['k'] == 'delivering') {
        $result = ManagerHolder::get('OrderBroadcast')->sendBySiteOrder($siteOrderId);
        if (!$result) {
          $smsview = 'not send';
        }
      }
      $newstatus = $status['k'];
    }

    $data = json_encode(array('status' => $newstatus, 'sms' => $smsview));
    die($data);
  }

  /**
   * Change shipment store AJAX
   */
  public function change_np_sender() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $npSenderId = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, items.*, blocked_admin.*');
    if (empty($siteorder)) {
      die('ERROR2');
    }
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }

    if ($npSenderId == 'NULL' || $npSenderId == '') {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'np_sender_id', null);
    } else {
      $counterPartySender = ManagerHolder::get('Counterparty')->getById($npSenderId, 'e.*');
      if (empty($counterPartySender)) {
        die('ERROR3');
      }
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'np_sender_id', $npSenderId);
      $this->layout->setLayout('ajax');
    }

    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
 * Change shipment store AJAX
 */
  public function change_shipment_store() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $shipmentStoreId = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, items.*, blocked_admin.*');
    if (empty($siteorder)) {
      die('ERROR2');
    }
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    // Delete all products requests for supplier on change siteorder status
    ManagerHolder::get('SupplierRequestProductParameterGroup')->deleteWhere('siteorder_code', $siteorder['code']);

    foreach ($siteorder['items'] as $item) {
      ManagerHolder::get('StoreReserve')->deleteWhere('siteorder_item_id', $item['id']);
    }

    ManagerHolder::get('StoreInventory')->updateProductStatuses();
    if ($shipmentStoreId == 'NULL' || $shipmentStoreId == '') {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'shipment_store_id', null);
    } else {
      $shipmentStore = ManagerHolder::get('Store')->getById($shipmentStoreId, 'e.*');
      if (empty($shipmentStore)) {
        die('ERROR3');
      }
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'shipment_store_id', $shipmentStoreId);
      $this->layout->setLayout('ajax');
    }

    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change status AJAX
   */
  public function change_manager() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $managerId = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, blocked_admin.*');
    if (empty($siteorder)) {
      die('ERROR2');
    }

    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    if ($managerId == 'NULL') {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'manager_id', null);
    } else {
      $manager = ManagerHolder::get('Admin')->getById($managerId, 'e.*');
      if (empty($manager)) {
        die('ERROR3');
      }
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'manager_id', $managerId);
      $this->layout->setLayout('ajax');
    }

    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change shipment date AJAX
   */

  public function change_shipment_date() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $shipmentDate = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, blocked_admin.*');
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }

	  Events::trigger('SiteOrder.shipmentDateAction', array(
		  'id' => $siteOrderId,
		  'shipment_date' => $shipmentDate,
	  ));

    ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'shipment_date', $shipmentDate);
    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change shipment date AJAX
   */

  public function change_paid_date() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $paidDate = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, blocked_admin.*');
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'paid_date', $paidDate);
    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change paid AJAX
   */
  public function change_paid() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $paid = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, blocked_admin.*');
    if (!empty($siteorder['blocked_admin_id']) && $siteorder['blocked_admin_id'] != $this->loggedInAdmin['id']) {
      $message = array('status' => 'busy', 'message' => 'Заказ заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'paid', $paid);
    if ($paid) {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'paid_date', date(DOCTRINE_DATE_FORMAT));
    }

    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change TTN number AJAX
   */

  public function change_ttn() {
    if (!isset($_GET['vl']) || !isset($_GET['siteOrderId'])) {
      die('ERROR1');
    }
    $siteOrderId = $_GET['siteOrderId'];
    $paid = $_GET['vl'];
    $siteorder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'e.*, blocked_admin.*');
    if (!empty($siteorder['blocked_admin_id'])) {
      $message = array('status' => 'busy', 'message' => 'Зака заблокирован! Сейчас его редактирует ' . $siteorder['blocked_admin']['name']);
      $data = json_encode($message);
      die($data);
    }
    ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'ttn_code', $_GET['vl']);
    $data = json_encode(array('status' => 'ok'));
    die($data);
  }

  /**
   * Change SMS Template AJAX
   */


  public function change_sms_template() {
    if (!isset($_POST['order']) || !isset($_POST['template'])) {
      die('ERROR INCOME DATA');
    }
    $orderId = $_POST['order'];
    $templateId = $_POST['template'];
    $template = ManagerHolder::get('SmsTemplate')->getById($templateId, 'e.*');
    $order = ManagerHolder::get('SiteOrder')->getById($orderId, 'e.*');
    if (empty($order) || empty($template)) {
      die('INCORRECT DATA');
    }
    if($template['type'] == SMS_TEMPLATE_TTN){
      $from = array('{ttn}', '{name}', '{order}', '  ');
      $to = array($order['ttn_code'], $order['fio'], $order['code'], '');
    }
    if($template['type'] == SMS_TEMPLATE_PAYMENT){
      $from = array('{sum}', '{name}', '{order}', '  ');
      $to = array($order['total'], $order['fio'], $order['code'], '');
    }
    $newtext = str_replace($from, $to, $template['text']);
    die($newtext);
  }

  /**
   * Send SMS AJAX
   */
  public function send_sms() {
    if (!isset($_GET['phone']) || !isset($_GET['smstext'])) {
      die('ERROR INCOME DATA');
    }
    $phone = $_GET['phone'];
    $text = str_replace(' ', '+', $_GET['smstext']);
    ManagerHolder::get('SMS')->sendMessage($phone, $text);
    die('ok');
  }



  /**
   * @param Object $entity
   * @return Object|void
   */
  protected function postUpdate(&$entity) {
    $this->processStatusChange($entity['id']);
//    $this->checkProductsCount($entity['id']);
  }

  /**
   * @param Object $entity
   * @return Object|void
   */
  protected function preUpdate(&$entity) {
    if ($entity['is_canceled']) {
      $cancelStatusId = ManagerHolder::get('SiteOrderStatus')->getIDByKey(SITEORDER_STATUS_CANCELED);
      $isSiteOrderCanceled = ManagerHolder::get('SiteOrder')->existsWhere(array('id' => $entity['id'], 'siteorder_status_id' => $cancelStatusId));
      if ($isSiteOrderCanceled) {
        $entity['siteorder_status_id'] = $cancelStatusId;
      }
    }
  }

  /**
   * Set filter
   */
  protected function setFilter() {
    parent::setFilter();

    foreach ($this->filters as $k => $filter) {
      if (strpos($k, 'shipment_date') !== FALSE) {
        unset($this->filters[$k]);
        break;
      }
    }

    if (isset($_GET['shipment_date_from']) && isset($_GET['shipment_date_to'])) {
      $this->filters['shipment_date BETWEEN'] = $_GET['shipment_date_from'] . ' AND ' . $_GET['shipment_date_to'];
    } else {
      if (isset($_GET['shipment_date_from'])) {
        $this->filters['shipment_date>='] = $_GET['shipment_date_from'];
      }
      if (isset($_GET['shipment_date_to'])) {
        $this->filters['shipment_date<='] = $_GET['shipment_date_to'];
      }
    }
  }

  /**
   * Post status change
   * @param $siteOrderId
   */
  protected function processStatusChange($siteOrderId) {
    $siteOrder = ManagerHolder::get('SiteOrder')->getById($siteOrderId, 'id, siteorder_status_id, is_canceled');
    $siteOrderStatus = ManagerHolder::get('SiteOrderStatus')->getById($siteOrder['siteorder_status_id']);

    if ($siteOrderStatus['is_cancel_reserve_status']) {
      $siteOrderItems = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteOrderId), 'e.*');
      foreach ($siteOrderItems as $item) {
        ManagerHolder::get('StoreReserve')->deleteWhere('siteorder_item_id', $item['id']);
      }
    }

    $notCountUpdateStatuses = array(SITEORDER_STATUS_SHIPPED, SITEORDER_STATUS_DELIVERED, SITEORDER_STATUS_RETURNED, SITEORDER_STATUS_CANCELED);
    if (in_array($siteOrderStatus['k'], $notCountUpdateStatuses) && !$siteOrder['is_canceled']) {
      ManagerHolder::get('SiteOrder')->updateById($siteOrderId, 'is_canceled', TRUE);
    }
    // TODO: Не происходит пересчет кол-во товаров и их статусов при смене статуса.
   }

   /**
   * Check products count
   * @param $siteOrderId
   */
  protected function checkProductsCount($siteOrderId) {
    // TODO: delete
    return TRUE;
  }

  /**
   * Ajax get cart view
   * @param $siteOrderId
   */
  public function ajax_get_cart_view($siteOrderId) {
    $siteOrder = ManagerHolder::get('SiteOrder')->getById($siteOrderId,'e.*');

    $cart = $this->getSiteorderCartWithItems($siteOrderId);
    $supplierNewRequests = ManagerHolder::get('SupplierRequest')->getAllWhere(array('supplier_request_status_id' => 1, 'receiver_id' => $siteOrder['shipment_store_id']), 'e.*');

    $this->load->helper('project');

    // RENDER NEW HTML OF CART DATA-----------------------------------------------------------------
    $html = '';

    $this->layout->setLayout('empty');

    $stores = ManagerHolder::get('Store')->getAsViewArray();
    $siteOrderStatus = ManagerHolder::get('SiteOrderStatus')->getById($cart['siteorder']['siteorder_status_id'], 'e.*');
    $onWayProducts = ManagerHolder::get('SupplierRequest')->getOnWayData();
    $this->layout->set('onWayProducts', $onWayProducts);
    $this->layout->set('siteOrderStatus', $siteOrderStatus);
    $this->layout->set('stores', $stores);
    $this->layout->set('cart', $cart);
    $this->layout->set("supplierNewRequests", $supplierNewRequests);
    $html .= $this->layout->view('siteorder/cart', TRUE);

    $products = ManagerHolder::get('Product')->getAll('e.*, product_params.*');
    foreach ($products as &$product) {
      if (!empty($product['product_params_id'])) {
        $product['params'] = ManagerHolder::get('ProductParams')->getById($product['product_params_id'], 'e.*');
      }
    }
    unset($product);

    $this->layout->set('products', $products);
    $html .= $this->layout->view('siteorder/add_to_cart', TRUE);

    die($html);
  }

  /**
   * Ajax reserve
   * @param $siteOrderItemId
   */
  public function ajax_reserve($siteOrderItemId) {
    $siteOrderItem = ManagerHolder::get('SiteOrderItem')->getById($siteOrderItemId, 'e.*, siteorder.*');

    if (!empty($siteOrderItem['parameter_group_id'])) {
      $productGroup = ManagerHolder::get('ParameterGroup')->getById($siteOrderItem['parameter_group_id'], 'e.*, product.*, inventories.*, reserves.*, main_parameter_value.*');
      $product = $productGroup['product'];
      $reserves = $productGroup['reserves'];
      $inventories = $productGroup['inventories'];
    } else {
      $product = ManagerHolder::get('Product')->getById($siteOrderItem['product_id'], 'e.*, inventories.*, reserves.*');
      $reserves = $product['reserves'];
      $inventories = $product['inventories'];
      $productGroup = array();
    }

    $storeReserves = array();
    $currentReserve = array('qty' => 0);
    foreach ($reserves as $reserve) {
      if (isset($storeReserves[$reserve['store_id']])) {
        $storeReserves[$reserve['store_id']] += $reserve['qty'];
      } else {
        $storeReserves[$reserve['store_id']] = $reserve['qty'];
      }
      if ($reserve['siteorder_item_id'] == $siteOrderItem['id']) {
        $currentReserve = $reserve;
      }
    }

    $storeInventories = array();
    foreach ($inventories as $inventory) {
      $storeInventories[$inventory['store_id']]['qty'] = $inventory['qty'];
      if (isset($storeReserves[$inventory['store_id']])) {
        $storeInventories[$inventory['store_id']]['free_qty'] = $inventory['qty'] - $storeReserves[$inventory['store_id']];
      } else {
        $storeInventories[$inventory['store_id']]['free_qty'] = $inventory['qty'];
      }
    }

    $this->layout->setLayout('ajax');
    $this->layout->set('cartItem', $siteOrderItem);
    $this->layout->set('product', $product);
    $this->layout->set('storeInventories', $storeInventories);
    $this->layout->set('storeReserves', $storeReserves);
    $this->layout->set('currentReserve', $currentReserve);
    $this->layout->set('productGroup', $productGroup);
    $this->layout->set('isSaved', FALSE);

    $this->layout->view('siteorder/reserve');
  }

  /**
   * Ajax reserve process
   * @param $siteOrderItemId
   */
  public function ajax_reserve_process($siteOrderItemId) {
    $siteOrderItem = ManagerHolder::get('SiteOrderItem')->getById($siteOrderItemId, 'e.*');
    if (empty($siteOrderItem)) {
      show_404();
    }

    foreach ($_POST['stores'] as $storeId => $data) {
      if ($storeId != ZAMMLER_STORE_ID && $storeId != MC_STORE_ID) {
        continue;

      }

      $reserve = array();
      $reserve['store_id'] = $storeId;
      $reserve['siteorder_item_id'] = $siteOrderItem['id'];

      $exists = ManagerHolder::get('StoreReserve')->existsWhere($reserve);
      if (!$exists) {
        $reserve['product_id'] = $siteOrderItem['product_id'];
        $reserve['product_group_id'] = $siteOrderItem['parameter_group_id'];
        $reserve['qty'] = $data['qty'];
        ManagerHolder::get('StoreReserve')->insert($reserve);
      } else {
        ManagerHolder::get('StoreReserve')->updateWhere($reserve, 'qty', $data['qty']);
      }
    }
    ManagerHolder::get('StoreInventory')->updateProductStatuses();
    $this->load->helper('common/itirra_ajax');
    set_flash_notice('Резерв успешно обновлен');
    uni_redirect(admin_site_url('siteorder/ajax_reserve/' . $siteOrderItem['id']));
  }

	/**
	 * Ajax update delivery price process
	 */
  public function ajax_update_delivery_price_process() {
		$siteOrder = ManagerHolder::get('SiteOrder')->getById($_GET['siteOrderId'], 'total, total_discount, total_with_discount');
		if (isset($_POST['delivery_price'])) {
			$update['delivery_price'] = $_POST['delivery_price'];
			$update['total_with_discount'] = $siteOrder['total'] + $update['delivery_price'];

			if (isset($siteOrder['total_discount'])) {
				$update['total_with_discount'] -= $siteOrder['total_discount'] ;
			}

			ManagerHolder::get('SiteOrder')->updateAllWhere(array('id' => $siteOrder['id']), $update);
		}

		die('DONE');
  }

  /**
   * Ajax total discount process
   */
  public function ajax_total_discount_process() {
    $entity = array('id' => $_GET['siteOrderId']);
    $this->processOrderDiscount($entity);

    die('DONE');
  }

  /**
   * Ajax save product parameters
   * @param int $entityId id
   */
  public function ajax_save_cart_item_params($entityId) {
    $paramsData =  array();
    $parameterGroupId = null;

    // Param 1
    if (is_not_empty($_POST['param1'])) {
      $paramsData[] = $_POST['param1'];

      $siteOrderItem = ManagerHolder::get('SiteOrderItem')->getById($entityId, 'e.*, product.*');

      $cartTotalWithoutCurrentItem = 0;
      $allSiteOrderItemsWithoutCurrent = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteOrderItem['siteorder_id']), 'e.*', null, array($siteOrderItem['id']));
      if(!empty($allSiteOrderItemsWithoutCurrent)) {
        foreach ($allSiteOrderItemsWithoutCurrent as $ccc) {
          $cartTotalWithoutCurrentItem += $ccc['item_total'];
        }
      }

      $parameterGroups = ManagerHolder::get('ParameterGroup')->getAllWhere(array('product_id' => $siteOrderItem['product_id']), 'e.*');
      $parameterGroupMainValueIDs = get_array_vals_by_second_key($parameterGroups, 'main_parameter_value_id');

      $newPrice = $siteOrderItem['product']['price'];

      if(!empty($parameterGroupMainValueIDs)) {
        $mainKey = array_search($_POST['param1'], $parameterGroupMainValueIDs);
        if($mainKey !== FALSE) {
          $parameterGroupId = $parameterGroups[$mainKey]['id'];

          if(!empty($parameterGroups[$mainKey]['price'])) {
            $newPrice = $parameterGroups[$mainKey]['price'];
          }
        }
      }
      if($newPrice != $siteOrderItem['price']) {
        $updateArray = array('price' => $newPrice,
          'item_total' => $newPrice*$siteOrderItem['qty']);
        ManagerHolder::get('SiteOrderItem')->updateAllWhere(array('id' => $siteOrderItem['id']), $updateArray);

        $newCartTotal = $cartTotalWithoutCurrentItem + $newPrice * $siteOrderItem['qty'];
        ManagerHolder::get('SiteOrder')->updateById($siteOrderItem['siteorder_id'], 'total', $newCartTotal);
      }

    }

    ManagerHolder::get('SiteOrder')->updateById($entityId, 'parameter_group_id', $parameterGroupId);

    // Param 2
    if (is_not_empty($_POST['param2'])) {
      $paramsData[] = $_POST['param2'];
    }

    if (!empty($paramsData)) {
      $paramsData = serialize($paramsData);
      ManagerHolder::get('SiteOrderItem')->updateById($entityId, 'additional_product_params', $paramsData);
    }
  }

  /**
   * Ajax get product parameters
   */
  public function ajax_get_cart_item_params($entityId) {
    $result = null;
    $entity = ManagerHolder::get('Product')->getById($entityId, 'e.*, possible_parameters.*, parameter_groups.*');
    if(!empty($entity['parameter_groups'])) {
      foreach ($entity['parameter_groups'] as &$group) {
        if(empty($group['price'])) {
          $group['price'] = $entity['price'];
        }
        $secondaryParamValueIds = get_array_vals_by_second_key($group['secondary_parameter_values_out'], 'id');
        $group['secondary_parameter_values'] = array();
        foreach ($entity['possible_parameters']['possible_parameter_values'] as $possibleParamValue) {
          if($entity['possible_parameters']['parameter_secondary_id'] == $possibleParamValue['parameter_id']) {
//            $possibleParamValue['on_order'] = FALSE;
//            if(in_array($possibleParamValue['id'], $secondaryParamValueIds) || $group['on_order'] == TRUE) {
//              $possibleParamValue['on_order'] = TRUE;
//            }
            $group['secondary_parameter_values'][] = $possibleParamValue;
          }
        }
      }
      $result['possible_parameters'] = $entity['possible_parameters'];
      $result['parameter_groups'] = $entity['parameter_groups'];
      die(json_encode($result));
    }
    die($result);
  }

  /**
   * Ajax get secondary_param_values
   */
  public function ajax_get_secondary_param_values($groupId) {

    $result = null;

    $group = ManagerHolder::get('ParameterGroup')->getById($groupId, 'e.*, product.*, secondary_parameter_values_out.*');
    $possibleParameters = ManagerHolder::get('ParameterProduct')->getById($group['product']['possible_parameters_id'], 'e.*, possible_parameter_values.*, parameter_secondary.*');

    if(!empty($possibleParameters['parameter_secondary_id'])) {
      $secondaryParamValueIds = get_array_vals_by_second_key($group['secondary_parameter_values_out'], 'id');

      $secondaryParamValues = array();
      foreach ($possibleParameters['possible_parameter_values'] as $possibleParamValue) {
        if($possibleParameters['parameter_secondary_id'] == $possibleParamValue['parameter_id']) {
//          $possibleParamValue['on_order'] = FALSE;
//          if(in_array($possibleParamValue['id'], $secondaryParamValueIds) || $group['on_order'] == TRUE) {
//            $possibleParamValue['on_order'] = TRUE;
//          }
          $secondaryParamValues[] = $possibleParamValue;
        }
      }

      $result['secondary_parameter_values'] = $secondaryParamValues;
      $result['parameter_secondary_name'] = $possibleParameters['parameter_secondary']['name'];
    }

    die(json_encode($result));
  }


  /**
   * Ajax add cart item
   */
  public function ajax_add_cart_item() {
    simple_validate_post(array('product_id', 'site_order_id', 'qty'));

    $siteOrder = ManagerHolder::get('SiteOrder')->getById($_POST['site_order_id'], 'e.*, user.*, items.*, siteorder_status.*, delivery.*');
    $user = ManagerHolder::get('User')->getById($siteOrder['user_id'], 'e.*');
    ManagerHolder::get('User')->addAvailableSalestoUser($user);

    $product = ManagerHolder::get('Product')->getById($_POST['product_id'], 'e.*, parameter_groups.*');
    ManagerHolder::get('Sale')->addAvailableSaleToProducts($user, $product);

    $cartItemData = array('product_id' => $_POST['product_id'],
      'siteorder_id' => $siteOrder['id'],
      'qty' => $_POST['qty'],
      'price' => $product['price']);

    // Grab params to array
    $params = array();
    $parameterGroupId = NULL;
    if (is_not_empty($_POST['param1'])) {
      if(!empty($product['parameter_groups'])) {
        $mainParamValueIDs = get_array_vals_by_second_key($product['parameter_groups'], 'main_parameter_value_id');
        $mainKey = array_search($_POST['param1'], $mainParamValueIDs);
        if($mainKey !== FALSE) {
          $newPrice = $product['parameter_groups'][$mainKey]['price'];
          $parameterGroupId = $product['parameter_groups'][$mainKey]['id'];
          if(!empty($newPrice) && $newPrice != $cartItemData['price']) {
            $cartItemData['price'] = $newPrice;
          }
        }
      }
      $params[] = $_POST['param1'];
      if (isset($_POST['param2']) && !empty($_POST['param2'])) {
        $params[] = $_POST['param2'];
      }
    }
    $cartItemData['parameter_group_id'] = $parameterGroupId;

    // Get inventories data
    $inventoriesWhere = array();
    $inventoriesWhere['product_id'] = $cartItemData['product_id'];
    if (!empty($cartItemData['parameter_group_id'])) {
      $inventoriesWhere['product_group_id'] = $cartItemData['parameter_group_id'];
    }
    $inventories = ManagerHolder::get('StoreInventory')->getAllWhere($inventoriesWhere, 'store_id, qty');
    $cartItemData['zammler_inventory_qty'] = 0;
    $cartItemData['mc_inventory_qty'] = 0;
    $cartItemData['other_stores_inventory_qty'] = 0;
    if (!empty($inventories)) {
      foreach ($inventories as $inventory) {
        if ($inventory['store_id'] == ZAMMLER_STORE_ID) {
          $cartItemData['zammler_inventory_qty'] = $inventory['qty'];
        } elseif ($inventory['store_id'] == MC_STORE_ID) {
          $cartItemData['mc_inventory_qty'] = $inventory['qty'];;
        } else {
          $cartItemData['other_stores_inventory_qty'] += $inventory['qty'];
        }
      }
    }

    // Set new item total
    $cartItemData['item_total'] = $cartItemData['price'] * $cartItemData['qty'];
//    if (isset($product['sale']['discount']) && !empty($product['sale']['discount'])) {
//      $cartItemData['discount_price'] = round($cartItemData['price'] - $cartItemData['price'] / 100 * $product['sale']['discount']);
//      $cartItemData['item_total'] = $cartItemData['discount_price'] * $cartItemData['qty'];
//    }

    if (!empty($params)) {
      $cartItemData['additional_product_params'] = serialize($params);
    }

    $cartItemData['id'] = ManagerHolder::get('SiteOrderItem')->insert($cartItemData);

    $siteOrder['total'] += $cartItemData['item_total'];

    // Get new delivery price if total changed
	  $delivery = ManagerHolder::get('Delivery')->getDeliveryOfOrderAmount($siteOrder['total']);
	  $siteOrder = ManagerHolder::get('SiteOrder')->updateSiteOrderDeliveryType($siteOrder, $delivery);
//
//	  if ($delivery !== false) {
//		  if ($siteOrder['delivery_id'] != $delivery['id']){
//			  $siteOrder['delivery_id'] = $delivery['id'];
//			  $siteOrder['delivery_price'] = $delivery['price'];
//			  // Update delivery type
//			  $updateData = array(
//				  'delivery_price' => $delivery['price'],
//				  'delivery_id' => $delivery['id']
//			  );
//			  ManagerHolder::get('SiteOrder')->updateAllWhere(array('id' => $siteOrder['id']), $updateData);
//
//		  }
//	  } else {
//		  $siteOrder['delivery_price'] = 0;
//		  ManagerHolder::get('SiteOrder')->executeNativeSQL(
//		  	'UPDATE site_order
//				 SET delivery_id = NULL, delivery_price = 0
//				 WHERE site_order.id = ' .$siteOrder['id']);
//	  }

		ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total', $siteOrder['total']);

    if (!empty($siteOrder['total_discount'])) {
      $totalWithDiscount = $siteOrder['total'] - $siteOrder['total_discount'];
      $totalWithDiscount += $siteOrder['delivery_price'];
	    ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total_with_discount', $totalWithDiscount);
    } else {
    	$totalWithDelivery = $siteOrder['total'];
	    $totalWithDelivery += $siteOrder['delivery_price'];
	    ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total_with_discount', $totalWithDelivery);
    }
	  $this->load->helper('project');

    die('OK');
  }

  /**
   * Ajax change qty
   * @param integer $ciId - cart item id
   */
  public function ajax_change_qty($siteOrderItemId) {

    $siteOrderItem = ManagerHolder::get('SiteOrderItem')->getById($siteOrderItemId, 'e.*');
    $siteOrder = ManagerHolder::get('SiteOrder')->getById($siteOrderItem['siteorder_id'], 'e.*');

    $cartTotalWithoutCurrentItem = 0;
    $allCartItemsWithoutCurrent = ManagerHolder::get('SiteOrderItem')->getAllWhere(array('siteorder_id' => $siteOrderItem['siteorder_id']), 'e.*', null, array($siteOrderItem['id']));
    if(!empty($allCartItemsWithoutCurrent)) {
      foreach ($allCartItemsWithoutCurrent as $ccc) {
        $cartTotalWithoutCurrentItem += $ccc['item_total'];
      }
    }

//     $cartTotalWithoutCurrentItem = $cart['total'] - $cartItem['qty'] * $cartItem['price'];
    $newItemTotal = $_POST['qty'] * $siteOrderItem['price'];
    if(is_not_empty($siteOrderItem['discount_price'])) {
      $cartTotalWithoutCurrentItem = $siteOrder['total'] - $siteOrderItem['qty'] * $siteOrderItem['discount_price'];
      $newItemTotal = $_POST['qty'] * $siteOrderItem['discount_price'];
    }

    ManagerHolder::get('SiteOrderItem')->updateAllWhere(array('id' => $siteOrderItem['id']), array('qty' => $_POST['qty'], 'item_total' => $newItemTotal));

    $cartTotal = $cartTotalWithoutCurrentItem + $newItemTotal;
    ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total', $cartTotal);

    if (!empty($siteOrder['total_discount'])) {
      $totalWithDiscount = $cartTotal - $siteOrder['total_discount'];
      ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total_with_discount', $totalWithDiscount);
    } else {
      ManagerHolder::get('SiteOrder')->updateById($siteOrder['id'], 'total_with_discount', $cartTotal);
    }
  }

}