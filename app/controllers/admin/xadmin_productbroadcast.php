<?php if (!defined("BASEPATH")) exit("No direct script access allowed");
/**
 * xAdmin_ProductBroadcast
 * This class has been auto-generated by Itirra
 */
require_once APPPATH . 'controllers/admin/base/base_admin_controller.php';
class xAdmin_ProductBroadcast extends Base_Admin_Controller {

  /** Additional Actions. Simple Array. Ex. array('view', 'print')*/
  protected $additionalItemActions = array('clone_product_broadcast', 'add_recipients_via_csv', 'preview');

  /**
   * preview
   * @param int $id
   */
  public function preview($id) {

    $this->load->helpers(array('project_broadcast', 'common/itirra_date', 'project'));

    $entity = ManagerHolder::get($this->managerName)->getById($id, 'e.*, products.*');

    $viewData = ManagerHolder::get('Common')->createViewDataPreview($entity);
    foreach ($viewData as $k => $v) {
      $this->layout->set($k, $v);
    }
    $this->layout->set('is_shop', TRUE);

    // Set subject
    $this->layout->set('subject', !empty($entity['subject']) ? $entity['subject'] : '');

    $this->layout->setLayout('email');
    $this->layout->setModule('email/product_broadcast');
    $this->layout->view('view');

    $html = $this->layout->renderLayout(TRUE);

    die($html);
  }

  /**
   * add_recipients_via_csv.
   */
  public function add_recipients_via_csv($id) {
    $e = ManagerHolder::get($this->entityName)->getById($id, 'e.*, countries.*, pregnancy_weeks.*, users.*, products.*');
    $this->layout->set('broadcast', $e);
    $this->layout->view('productbroadcast/add_recipients_via_csv');
  }

  /**
   * add_recipients_via_csv_process.
   */
  public function add_recipients_via_csv_process() {

    $e = ManagerHolder::get($this->entityName)->getById($_POST['id'], 'e.*, countries.*, pregnancy_weeks.*, users.*, products.*');
    if(empty($e) || !isset($_FILES['file'])) {
      show_404();
    }

    // Load CSV Library
    $this->load->library('common/csv');

    $this->csv->setInputFileEncoding('utf-8');

    $this->csv->setSeparator("\r");

    // Read CSV File
    $this->csv->readFile($_FILES['file']['tmp_name']);

    $emails = array();

    while (($row = $this->csv->readRow()) !== FALSE) {
      foreach ($row as $r) {
        $emails[] = $r;
      }
    }

    if(empty($emails)) {
      set_flash_error('Неправильный формат файла. Email-ы должны быть разделены запятой. Например: email1@mail.ru,email12@itirra.com,assd@asdas.net');
      redirect_to_referral();
    }

    $users = ManagerHolder::get('User')->getAllWhere(array('auth_info.email' => $emails), 'e.*');
    ManagerHolder::get('ProductBroadcastUser')->deleteAllWhere(array('product_broadcast_id' => $e['id']));
    if(!empty($users)) {
      foreach ($users as $u) {
        ManagerHolder::get('ProductBroadcastUser')->insert(array('product_broadcast_id' => $e['id'], 'user_id' => $u['id']));
      }
    }

    set_flash_notice('Добавлено ' . count($users) . ' пользователей к рассылке');
    redirect_to_referral();
  }

  /**
   * clone_product_broadcast.
   */
  public function clone_product_broadcast($id) {

    $e = ManagerHolder::get($this->entityName)->getById($id, 'e.*, countries.*, pregnancy_weeks.*, users.*, products.*');

    unset($e['id']);

    $e['is_sent'] = TRUE;
    $e['countries'] = get_array_vals_by_second_key($e['countries'], 'id');
    $e['pregnancy_weeks'] = get_array_vals_by_second_key($e['pregnancy_weeks'], 'id');
    $e['users'] = get_array_vals_by_second_key($e['users'], 'id');
    $e['products'] = get_array_vals_by_second_key($e['products'], 'id');
    $e['name'] = $e['name'] . lang('clone.word');

    // Check for existing clones
    ManagerHolder::get($this->entityName)->setSearch($e['name'], 'name', 'starts_with');
    $clones = ManagerHolder::get($this->entityName)->getAll('name');
    if(!empty($clones)) {
      $number = 1;
      foreach($clones as $clone) {
        if(preg_match("@" . lang('clone.word') . "([0-9]+)$@", $clone['name'], $matches)) {
          $n = $matches[1];
          if($n >= $number) {
            $number = $n + 1;
          }
        }
      }
      $e['name'] .= $number;
    }


    $e['id'] = ManagerHolder::get($this->entityName)->insert($e);

    set_flash_notice('Рассылка клонирована успешно');
    redirect_to_referral();
  }


  /**
   * SetAddEditDataAndShowView.
   * Set all needed view data and show add_edit form.
   * @param object $entity
   */
  protected function setAddEditDataAndShowView($entity) {
    $this->preProcessFields($entity);

    // Holy shit!!! This is a hack O_O
    if (isset($entity['users']) && !empty($entity['users'])) {
      foreach ($entity['users'] as &$user) {
        $user['name'] = $user['auth_info']['email'];
      }
    }

    $this->layout->set("fields", $this->fields);
    $pageNum = ManagerHolder::get($this->managerName)->getEntityPageNum($entity['id'], $this->perPage);
    $backUrl = $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName . ($pageNum > 1 ? ('/' . $this->config->item('page_prefix') . $pageNum) : '' ) . get_get_params());
    $this->layout->set("backUrl", $backUrl);
    if (!empty($entity['id'])) {
      $this->layout->set("nextUrl", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/next/' . $entity['id'] . '/' . get_get_params());
      $this->layout->set("prevUrl", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/prev/' . $entity['id'] . '/' . get_get_params());
    }
    $this->layout->set("processLink", $this->adminBaseRoute . '/' .  strtolower($this->entityUrlName) . '/add_edit_process');
    $this->preAddEditView($entity);
    $this->layout->set("entity", $entity);
    $this->layout->set("actions", $this->actions);
    $this->layout->set("print", $this->print);
    $this->layout->view($this->itemView);
  }

  /**
   * Implementation of POST_SAVE event callback
   * @param Object $entity reference
   * @return Object
   */
  protected function postSave(&$entity) {
    if(isset($_POST['products']) && !empty($_POST['products'])) {
      ManagerHolder::get('ProductBroadcastProduct')->deleteAllWhere(array('product_broadcast_id' => $entity['id']));
      foreach ($_POST['products'] as $pId) {
        $data = array('product_broadcast_id' => $entity['id'],
                      'product_id' => $pId);
        ManagerHolder::get('ProductBroadcastProduct')->insert($data);
      }
    }
  }

}