<?php if (!defined("BASEPATH")) exit("No direct script access allowed");
/**
 * xAdmin_Sale
 * This class has been auto-generated by Itirra
 */
require_once APPPATH . 'controllers/admin/base/base_admin_controller.php';

class xAdmin_Sale extends Base_Admin_Controller
{

  /** Filters. */
  protected $filters = array("pregnancyweeks.id" => "", "products.id" => "");

  /** AdditionalItemActions. */
  protected $additionalItemActions = array("add_recipients_via_csv");

  public function add_recipients_via_csv($id)
  {
    $e = ManagerHolder::get($this->entityName)->getById($id, 'e.*, countries.*, pregnancy_weeks.*, users.*, products.*');
    $this->layout->set('sale', $e);
    $this->layout->view('sale/index');
  }

  public function add_recipients_via_csv_process() {
    $e = ManagerHolder::get($this->entityName)->getById($_POST['id'], 'e.*, countries.*, pregnancy_weeks.*, users.*, products.*');
    if (empty($e) || !isset($_FILES['file'])) {
      show_404();
    }

    // Load CSV Library
    $this->load->library('common/csv');

    $this->csv->setInputFileEncoding('utf-8');

    $this->csv->setSeparator("\r");

    // Read CSV File
    $this->csv->readFile($_FILES['file']['tmp_name']);

    $emails = array();

    while (($row = $this->csv->readRow()) !== FALSE) {
      foreach ($row as $r) {
        $emails[] = $r;
      }
    }

    if (empty($emails)) {
      set_flash_error('Неправильный формат файла. Email-ы должны начинаться с новой строки без затяных и пробелов. Например: email1@mail.ru -> (Enter)');
      redirect_to_referral();
    }

    $users = ManagerHolder::get('User')->getAllWhere(array('auth_info.email' => $emails), 'e.*');
    ManagerHolder::get('UserSale')->deleteAllWhere(array('sale_id' => $e['id']));
    if (!empty($users)) {
      foreach ($users as $u) {
        ManagerHolder::get('UserSale')->insert(array('sale_id' => $e['id'], 'user_id' => $u['id']));
      }
    }

    set_flash_notice('Добавлено ' . count($users) . ' пользователей');
    redirect(admin_site_url(strtolower($this->entityName)) . '/' . 'add_edit' . '/' . $_POST['id']);
  }

  /**
   * preProcessFields
   * the method is called before passing
   * fields to the layout
   */
  protected function preProcessFields(&$entity) {
    parent::preProcessFields($entity);

    // Holy shit!!! This is a hack O_O
    if (isset($entity['users']) && !empty($entity['users'])) {
      foreach ($entity['users'] as &$user) {
        $user['name'] = $user['auth_info']['email'];
      }
    }
  }

}

