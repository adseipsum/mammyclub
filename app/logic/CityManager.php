<?php if (!defined("BASEPATH")) exit("No direct script access allowed");
/**
 * CityManager
 * This class has been auto-generated by Itirra
 */
require_once APPPATH . 'logic/base/BaseManager.php';
class CityManager extends BaseManager {

  /** Order By. */
  protected $orderBy = 'name ASC';

  /** Fields. */
  public $fields = array("name" => array("type" => "input", "class" => "required", "attrs" => array("maxlength" => 255)),
                         "name_ru" => array("type" => "input", "class" => "required", "attrs" => array("maxlength" => 255)),
                         "ref" => array("type" => "input", "class" => "required", "attrs" => array("maxlength" => 50)));


  /** List params. */
  public $listParams = array("name");

	/**
	 * NewPost sync city
	 */
	public function sync()
  {

    $CI = &get_instance();
    $CI->load->library('NewPostSdk');
    $CI->newpostsdk->setApiKey('eb5218a4df21f575da127c06afe055a7');

    $cities = $CI->newpostsdk->getCities();

    foreach ($cities as $city) {
      $entity = array();
      $entity['name'] = $city->Description;
      $entity['name_ru'] = $city->DescriptionRu;

      $exists = ManagerHolder::get('City')->existsWhere(array('ref' => $city->Ref));
      if ($exists) {
        ManagerHolder::get('City')->updateAllWhere(array('ref' => $city->Ref), $entity);
      } else {
        $entity['ref'] = $city->Ref;
        ManagerHolder::get('City')->insert($entity);
      }
    }
  }

}