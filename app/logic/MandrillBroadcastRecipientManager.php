<?php if (!defined("BASEPATH")) exit("No direct script access allowed");
/**
 * MandrillBroadcastRecipientManager
 * This class has been auto-generated by Itirra
 */
require_once APPPATH . 'logic/base/BaseManager.php';
class MandrillBroadcastRecipientManager extends BaseManager {

  /** Name field. */
  protected $nameField = "email";

  /** Order by */
  protected $orderBy = "updated_at DESC";

  /** Fields. */
  public $fields = array("email" => array("type" => "input", "attrs" => array("maxlength" => 255)),
                         "user" => array("type" => "select", "relation" => array("entity_name" => "User")),
                         "is_read" => array("type" => "checkbox"),
                         "data" => array("type" => "array"),
                         "broadcast" => array("type" => "select", "relation" => array("entity_name" => "MandrillBroadcast")),
                         "updated_at" => array("type" => "datetime"),
                         "visited_links" => array("type" => "multipleselect", "relation" => array("entity_name" => "MandrillBroadcastLink", "search" => TRUE)));

  /** List params. */
  public $listParams = array("email", "is_read", "broadcast.subject", "updated_at");

  /**
   * PreProcessWhereQuery.
   * OVERRIDE THIS METHOD IN A SUBCLASS TO ADD joins and other stuff.
   * @param Doctrine_Query $query
   * @return Doctrine_Query
   */
  protected function preProcessWhereQuery($query, $pref, $what = '*') {
    $query = parent::preProcessWhereQuery($query, $pref, $what);
    if (strpos($what, 'MandrillBroadcastVisitedLink.') !== FALSE || $what == '*') {
      $query->addSelect("MandrillBroadcastVisitedLink_link.*")->leftJoin("MandrillBroadcastVisitedLink.link MandrillBroadcastVisitedLink_link");
    }
    return $query;
  }

  /**
   * createUserStatsFromArray
   *
   * @param array $records
   * @return array
   */
  public function createUserStatsFromArray(array $records)
  {
    $result = array();
    if (!empty($records)) {
      foreach ($records as $r) {
        $result[] = array(
          'created_at' => $r['updated_at'],
          'subject' => $r['broadcast']['subject'],
          'open_count' => count($r['MandrillBroadcastOpen']),
          'opens' => get_array_vals_by_second_key($r['MandrillBroadcastOpen'], 'created_at'),
          'visited_links' => get_array_vals_by_second_key($r['MandrillBroadcastVisitedLink'], 'link', 'url'),
          'html_url' => $r['email_html'] ? admin_site_url('mandrillbroadcast/view_webversion/' . $r['id']) : null
        );
      }
    }
    return $result;
  }

}